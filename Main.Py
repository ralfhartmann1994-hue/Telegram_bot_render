import os
import time
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
import threading

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("Ø¶Ø¹ TELEGRAM_TOKEN ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")

bot = telebot.TeleBot(TOKEN)

# ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© =====
users = {}  # user_id -> {"name":.., "age":.., "gender":.., "respect":.., "profile_locked":False}
waiting_users = {}  # user_id -> {"topic":.., "gender_pref":..}
active_chats = {}  # user_id -> partner_id
chat_logs = {}  # user_id -> [last_50_messages]
warnings_sent = set()
banned_users = {}  # user_id -> ban_end_timestamp

# ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø© =====
bad_words = [
"ÙƒØ³","ÙƒØ³Ù…Ùƒ","ÙƒØ³ÙŠ","ÙƒØ³Ø³","ÙƒØ³Ø³Ø³","ÙƒØ³Ø³Ø³Ø³","ÙƒØ³Ù…Ùˆ","ÙƒØµÙ…Ùƒ","Ø§ÙŠØ±","Ø§ÙŠØ±ÙŠ","Ø§ÙŠØ±Ù†Ø§","Ø·ÙŠØ²Ù†Ø§","Ø·ÙŠØ²",
"ÙƒØ³Ø®ØªÙƒ","ÙŠÙ„Ø¹Ù† Ø±Ø¨Ùƒ","ÙŠÙ„Ø¹Ù† Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø±ÙˆØ­Ùƒ","Ø¹Ù†Ø±Ø¨Ùƒ","Ø¹Ù†Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø´ÙØ±Ø§ØªÙƒ","Ù‚Ø­Ø¨Ø©","Ø´Ø±Ù…ÙˆØ·Ø©",
"Ø´Ù„ÙƒØ©","Ù…Ù†ØªØ§ÙƒØ©","Ø³Ø±Ù…ÙˆØ·Ø©","Ù‚Ø­Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù…Ù†ÙŠÙƒ","Ù…ÙƒØ³ÙƒØ³"
]

# ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def get_penalty(respect, bad_count):
    """Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…"""
    penalty = 0
    if respect >= 76:
        penalty = bad_count // 2   # ÙƒÙ„ ÙƒÙ„Ù…ØªÙŠÙ† = Ù†Ù‚Ø·Ø©
    elif 71 <= respect <= 75:
        penalty = bad_count        # ÙƒÙ„ ÙƒÙ„Ù…Ø© = Ù†Ù‚Ø·Ø©
    elif 61 <= respect <= 70:
        penalty = bad_count * 2
    elif 51 <= respect <= 60:
        penalty = bad_count * 3
    elif 41 <= respect <= 50:
        penalty = bad_count * 5
    elif 26 <= respect <= 40:
        penalty = bad_count * 10
    return penalty

def is_banned(user_id):
    if user_id in banned_users:
        if time.time() < banned_users[user_id]:
            return True
        else:
            del banned_users[user_id]
    return False

def add_message(user_id, text):
    if user_id not in chat_logs:
        chat_logs[user_id] = []
    chat_logs[user_id].append(text)
    if len(chat_logs[user_id]) > 50:
        chat_logs[user_id] = chat_logs[user_id][-50:]

# ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© =====
def main_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"), KeyboardButton("ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"), KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø«"))
    return kb

# ===== Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
@bot.message_handler(commands=['start'])
def start(msg):
    user_id = msg.from_user.id
    if user_id not in users:
        users[user_id] = {"name": None, "age": None, "gender": None, "respect": 80, "profile_locked": False}
        bot.send_message(user_id, "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.\nÙ…Ø§ Ø§Ø³Ù…ÙƒØŸ", reply_markup=main_menu())
    else:
        bot.send_message(user_id, "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!", reply_markup=main_menu())

# ===== Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
@bot.message_handler(func=lambda m: m.text == "ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ")
def profile_menu(msg):
    user = users.get(msg.from_user.id)
    if not user: return
    info = f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {user['age']}\nâš§ï¸ Ø§Ù„Ø¬Ù†Ø³: {user['gender']}\nâ­ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {user['respect']}"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(msg.chat.id, info, reply_markup=kb)

# ===== Ø§Ù„Ø¨Ø­Ø« =====
@bot.message_handler(func=lambda m: m.text == "ğŸ” Ø§Ù„Ø¨Ø­Ø«")
def search_menu(msg):
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("ğŸ§  ÙÙ„Ø³ÙØ©", "âš½ Ø±ÙŠØ§Ø¶Ø©")
    kb.add("â˜ªï¸ Ø¯ÙŠÙ†", "ğŸ›ï¸ Ø³ÙŠØ§Ø³Ø©")
    kb.add("ğŸ¤ ØªØ¹Ø§Ø±Ù")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(msg.chat.id, "Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙ†Ø§Ù‚Ø´ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø§Ø®ØªØ± Ù…Ø¬Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø´:", reply_markup=kb)

# ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =====
@bot.message_handler(func=lambda m: m.text in ["ğŸ§  ÙÙ„Ø³ÙØ©","âš½ Ø±ÙŠØ§Ø¶Ø©","â˜ªï¸ Ø¯ÙŠÙ†","ğŸ›ï¸ Ø³ÙŠØ§Ø³Ø©","ğŸ¤ ØªØ¹Ø§Ø±Ù"])
def topic_choice(msg):
    topic = msg.text
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(f"{topic} ğŸ‘¨", f"{topic} ğŸ‘©")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(msg.chat.id, "Ø§Ø®ØªØ± Ù…Ø¹ Ù…Ù† ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯Ø«:", reply_markup=kb)

# ===== Ø§Ù„Ø¥Ø¨Ù„Ø§Øº =====
@bot.message_handler(func=lambda m: m.text == "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº")
def report_user(msg):
    user_id = msg.from_user.id
    if user_id not in active_chats:
        bot.send_message(user_id, "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¨Ø¯ÙˆÙ† ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø¯Ø´Ø©.")
        return
    partner_id = active_chats[user_id]
    messages = chat_logs.get(partner_id, [])
    bad_count = sum(1 for m in messages for w in bad_words if w in m)
    penalty = get_penalty(users[partner_id]["respect"], bad_count)
    users[partner_id]["respect"] -= penalty
    bot.send_message(user_id, f"âœ… ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº. Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø©: {bad_count}\nØ§Ù„Ø®ØµÙ…: {penalty} Ù†Ù‚Ø§Ø·.")
    bot.send_message(partner_id, "ğŸš¨ Ù„Ù‚Ø¯ ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ùƒ! Ø§Ù†ØªØ¨Ù‡ Ø¥Ù„Ù‰ Ø³Ù„ÙˆÙƒÙƒ.")

# (ØªØ§Ø¨Ø¹ Ø§Ù„ÙƒÙˆØ¯: Ù…Ø·Ø§Ø¨Ù‚Ø©ØŒ Ù…Ø­Ø§Ø¯Ø«Ø©ØŒ Ù…ØºØ§Ø¯Ø±Ø© Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©ØŒ Ø§Ù„Ø­Ø¸Ø±ØŒ Ø¥Ù„Ø®...)
bot.send_message(user_id, "Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø¨Ø³Ø¨Ø¨ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯.")
            return

    # Ø¨Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    save_profiles()


# ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© =====
def main_menu(user_id):
    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ” Ø§Ù„Ø¨Ø­Ø«", "ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", "ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
    bot.send_message(user_id, "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:", reply_markup=markup)


@bot.message_handler(func=lambda msg: msg.text == "ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
def handle_home(msg):
    main_menu(msg.chat.id)


@bot.message_handler(func=lambda msg: msg.text == "ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ")
def handle_profile(msg):
    user_id = msg.chat.id
    profile = profiles.get(str(user_id))
    if profile:
        bot.send_message(user_id, f"ğŸ‘¤ Ø§Ø³Ù…Ùƒ: {profile['name']}\nğŸ‚ Ø¹Ù…Ø±Ùƒ: {profile['age']}\nâš§ Ø¬Ù†Ø³Ùƒ: {profile['gender']}\nğŸ’¯ Ø§Ø­ØªØ±Ø§Ù…Ùƒ: {profile['respect']}")
    else:
        bot.send_message(user_id, "Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· /start")


@bot.message_handler(func=lambda msg: msg.text == "ğŸ” Ø§Ù„Ø¨Ø­Ø«")
def handle_search(msg):
    user_id = msg.chat.id
    if str(user_id) not in profiles:
        bot.send_message(user_id, "Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± /start")
        return

    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ“š ÙÙ„Ø³ÙØ© ğŸ§‘", "ğŸ“š ÙÙ„Ø³ÙØ© ğŸ‘©")
    markup.add("âš½ Ø±ÙŠØ§Ø¶Ø© ğŸ§‘", "âš½ Ø±ÙŠØ§Ø¶Ø© ğŸ‘©")
    markup.add("ğŸ•Œ Ø¯ÙŠÙ† ğŸ§‘", "ğŸ•Œ Ø¯ÙŠÙ† ğŸ‘©")
    markup.add("ğŸ› Ø³ÙŠØ§Ø³Ø© ğŸ§‘", "ğŸ› Ø³ÙŠØ§Ø³Ø© ğŸ‘©")
    markup.add("ğŸ¤ ØªØ¹Ø§Ø±Ù ğŸ§‘", "ğŸ¤ ØªØ¹Ø§Ø±Ù ğŸ‘©")
    bot.send_message(user_id, "Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙ†Ø§Ù‚Ø´ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ø§Ù„ ÙˆØ§Ù„Ø¬Ù†Ø³:", reply_markup=markup)
# ===== Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† =====
waiting_users = {  # { (topic, gender): [user_ids...] }
    ("ÙÙ„Ø³ÙØ©", "Ø°ÙƒØ±"): [],
    ("ÙÙ„Ø³ÙØ©", "Ø£Ù†Ø«Ù‰"): [],
    ("Ø±ÙŠØ§Ø¶Ø©", "Ø°ÙƒØ±"): [],
    ("Ø±ÙŠØ§Ø¶Ø©", "Ø£Ù†Ø«Ù‰"): [],
    ("Ø¯ÙŠÙ†", "Ø°ÙƒØ±"): [],
    ("Ø¯ÙŠÙ†", "Ø£Ù†Ø«Ù‰"): [],
    ("Ø³ÙŠØ§Ø³Ø©", "Ø°ÙƒØ±"): [],
    ("Ø³ÙŠØ§Ø³Ø©", "Ø£Ù†Ø«Ù‰"): [],
    ("ØªØ¹Ø§Ø±Ù", "Ø°ÙƒØ±"): [],
    ("ØªØ¹Ø§Ø±Ù", "Ø£Ù†Ø«Ù‰"): [],
}

# Ø³Ø¬Ù„ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø¤Ù‚Øª (Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø©)
chat_history = {}  # {user_id: [("Ù…Ù†", "Ø§Ù„Ù†Øµ"), ...]}


def add_to_history(user_id, sender, text):
    if user_id not in chat_history:
        chat_history[user_id] = []
    chat_history[user_id].append((sender, text))
    if len(chat_history[user_id]) > 50:
        chat_history[user_id] = chat_history[user_id][-50:]


@bot.message_handler(func=lambda msg: msg.text in [
    "ğŸ“š ÙÙ„Ø³ÙØ© ğŸ§‘", "ğŸ“š ÙÙ„Ø³ÙØ© ğŸ‘©",
    "âš½ Ø±ÙŠØ§Ø¶Ø© ğŸ§‘", "âš½ Ø±ÙŠØ§Ø¶Ø© ğŸ‘©",
    "ğŸ•Œ Ø¯ÙŠÙ† ğŸ§‘", "ğŸ•Œ Ø¯ÙŠÙ† ğŸ‘©",
    "ğŸ› Ø³ÙŠØ§Ø³Ø© ğŸ§‘", "ğŸ› Ø³ÙŠØ§Ø³Ø© ğŸ‘©",
    "ğŸ¤ ØªØ¹Ø§Ø±Ù ğŸ§‘", "ğŸ¤ ØªØ¹Ø§Ø±Ù ğŸ‘©"
])
def handle_topic_choice(msg):
    user_id = msg.chat.id
    choice = msg.text

    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ø§Ù„ ÙˆØ§Ù„Ø¬Ù†Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    if "ÙÙ„Ø³ÙØ©" in choice: topic = "ÙÙ„Ø³ÙØ©"
    elif "Ø±ÙŠØ§Ø¶Ø©" in choice: topic = "Ø±ÙŠØ§Ø¶Ø©"
    elif "Ø¯ÙŠÙ†" in choice: topic = "Ø¯ÙŠÙ†"
    elif "Ø³ÙŠØ§Ø³Ø©" in choice: topic = "Ø³ÙŠØ§Ø³Ø©"
    else: topic = "ØªØ¹Ø§Ø±Ù"

    if "ğŸ§‘" in choice: target_gender = "Ø°ÙƒØ±"
    else: target_gender = "Ø£Ù†Ø«Ù‰"

    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ù…Ø·Ø§Ø¨Ù‚
    key = (topic, target_gender)
    opposite_gender = "Ø£Ù†Ø«Ù‰" if profiles[str(user_id)]["gender"] == "Ø°ÙƒØ±" else "Ø°ÙƒØ±"

    # Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙØ¦Ø© Ù„ÙƒÙ† Ø¨Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ø¢Ø®Ø±ØŸ
    partner_key = (topic, profiles[str(user_id)]["gender"])
    if waiting_users.get(partner_key) and waiting_users[partner_key]:
        partner_id = waiting_users[partner_key].pop(0)

        # ØªÙ‡Ù†Ø¦Ø© ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª
        partner_profile = profiles[str(partner_id)]
        my_profile = profiles[str(user_id)]

        bot.send_message(user_id,
            f"ğŸ‰ ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ!\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {partner_profile['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {partner_profile['age']}\nğŸ’¯ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {partner_profile['respect']}")
        bot.send_message(partner_id,
            f"ğŸ‰ ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ!\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {my_profile['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {my_profile['age']}\nğŸ’¯ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {my_profile['respect']}")

        bot.send_message(user_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù† âœ…")
        bot.send_message(partner_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù† âœ…")

    else:
        waiting_users[key].append(user_id)
        bot.send_message(user_id, "â³ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… Ù…Ø·Ø§Ø¨Ù‚ØªÙƒ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø´Ø®Øµ Ù…Ù†Ø§Ø³Ø¨.")


# ===== Ø²Ø± Ø§Ù„Ø¥Ø¨Ù„Ø§Øº =====
@bot.message_handler(commands=["report"])
def handle_report(msg):
    user_id = msg.chat.id
    if user_id not in chat_history:
        bot.send_message(user_id, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ù‡Ø§.")
        return

    # Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø©
    history = chat_history[user_id]
    bad_count = sum(any(bad in text for bad in bad_words) for _, text in history)

    # Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
    if str(user_id) in profiles:
        apply_respect_penalty(user_id, bad_count)

    bot.send_message(user_id, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØ³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©.")


# ===== Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† =====
@bot.message_handler(func=lambda msg: True)
def relay_messages(msg):
    user_id = msg.chat.id
    text = msg.text

    # Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
    add_to_history(user_id, "me", text)

    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Ù…Ø±ØªØ¨Ø·
    for key, users in waiting_users.items():
        if user_id in users:
            # Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø²Ø§Ù„ ÙŠÙ†ØªØ¸Ø± Ù…Ø·Ø§Ø¨Ù‚Ø©
            return

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¥Ù† ÙˆØ¬Ø¯
    for key, users in waiting_users.items():
        for uid in users:
            if uid == user_id:
                continue

    # Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ (ØªØ·ÙˆÙŠØ± Ù„Ø§Ø­Ù‚) â€” ØªØ­ØªØ§Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù„Ø³Ø§Øª Ù†Ø´Ø·Ø©
    # Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† ÙŠØªØ­Ø¯Ø« Ù…Ø¹ Ù…Ù† Ø¨Ø§Ù„Ø¶Ø¨Ø·
    # ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· user_id â†” partner_id ÙÙŠ dict Ù…Ù†ÙØµÙ„ active_chats


print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
bot.polling()
# ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© =====
active_chats = {}  # user_id -> partner_id
leave_timers = {}   # user_id -> ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©

# Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©ØŒ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†:
def start_chat(user_id, partner_id):
    active_chats[user_id] = partner_id
    active_chats[partner_id] = user_id
    leave_timers[user_id] = time.time()
    leave_timers[partner_id] = time.time()
    bot.send_message(user_id, "âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†.")
    bot.send_message(partner_id, "âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†.")

# Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙŠÙƒÙŠÙ†
@bot.message_handler(func=lambda msg: True)
def relay(msg):
    user_id = msg.chat.id
    text = msg.text

    # ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø±
    if is_banned(user_id):
        bot.send_message(user_id, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø³Ø¬Ù„
    add_to_history(user_id, "me", text)

    # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø±ÙŠÙƒ Ù†Ø´Ø·
    if user_id in active_chats:
        partner_id = active_chats[user_id]
        sender_name = profiles[str(user_id)]["name"] if str(user_id) in profiles else "Ù…Ø³ØªØ®Ø¯Ù…"
        bot.send_message(partner_id, f"ğŸ’¬ {sender_name}: {text}")
    else:
        bot.send_message(user_id, "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ù†Ø´Ø·ØŒ Ø§Ø¶ØºØ· ğŸ” Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ.")

# ===== Ø²Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© =====
@bot.message_handler(func=lambda msg: msg.text == "âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª")
def leave_chat(msg):
    user_id = msg.chat.id
    if user_id not in active_chats:
        bot.send_message(user_id, "â„¹ï¸ Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return

    elapsed = time.time() - leave_timers.get(user_id, 0)
    if elapsed < 30:
        bot.send_message(user_id, f"â³ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù‚Ø¨Ù„ 30 Ø«Ø§Ù†ÙŠØ©. ØªØ¨Ù‚Ù‰ {int(30 - elapsed)} Ø«Ø§Ù†ÙŠØ©.")
        return

    # ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ğŸšª", callback_data=f"confirm_leave_{user_id}"))
    bot.send_message(user_id, "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ", reply_markup=markup)


@bot.callback_query_handler(func=lambda call: call.data.startswith("confirm_leave_"))
def confirm_leave(call):
    user_id = int(call.data.split("_")[-1])
    if user_id not in active_chats:
        bot.answer_callback_query(call.id, "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.")
        return

    partner_id = active_chats[user_id]
    bot.send_message(user_id, "ğŸšª ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    bot.send_message(partner_id, "ğŸšª Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    for uid in [user_id, partner_id]:
        active_chats.pop(uid, None)
        leave_timers.pop(uid, None)
