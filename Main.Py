import os
import time
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from telebot.types import ReplyKeyboardRemove
import threading

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("Ø¶Ø¹ TELEGRAM_TOKEN ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")

bot = telebot.TeleBot(TOKEN)

# ===== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
users = {}  # user_id -> {"name", "age", "gender", "respect", "gender_changed", "step"}
waiting_users = {}  # (topic, gender) -> [user_ids]
active_chats = {}  # user_id -> partner_id
leave_timers = {}  # user_id -> Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
chat_logs = {}  # user_id -> [("me"/"partner", msg)]
banned_users = {}  # user_id -> ban_end_timestamp
warnings_sent = set()

TOPICS = ["ÙÙ„Ø³ÙØ©", "Ø±ÙŠØ§Ø¶Ø©", "Ø¯ÙŠÙ†", "Ø³ÙŠØ§Ø³Ø©", "ØªØ¹Ø§Ø±Ù"]
GENDERS = ["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰"]

bad_words = [
    "ÙƒØ³","ÙƒØ³Ù…Ùƒ","ÙƒØ³ÙŠ","ÙƒØ³Ø³","ÙƒØ³Ø³Ø³","ÙƒØ³Ø³Ø³Ø³","ÙƒØ³Ù…Ùˆ","ÙƒØµÙ…Ùƒ","Ø§ÙŠØ±","Ø§ÙŠØ±ÙŠ","Ø§ÙŠØ±Ù†Ø§","Ø·ÙŠØ²Ù†Ø§","Ø·ÙŠØ²",
    "ÙƒØ³Ø®ØªÙƒ","ÙŠÙ„Ø¹Ù† Ø±Ø¨Ùƒ","ÙŠÙ„Ø¹Ù† Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø±ÙˆØ­Ùƒ","Ø¹Ù†Ø±Ø¨Ùƒ","Ø¹Ù†Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø´ÙØ±Ø§ØªÙƒ","Ù‚Ø­Ø¨Ø©","Ø´Ø±Ù…ÙˆØ·Ø©",
    "Ø´Ù„ÙƒØ©","Ù…Ù†ØªØ§ÙƒØ©","Ø³Ø±Ù…ÙˆØ·Ø©","Ù‚Ø­Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù…Ù†ÙŠÙƒ","Ù…ÙƒØ³ÙƒØ³"
]

# ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def get_respect_badge(score):
    if score >= 80: return "ğŸŒŸ"
    if score >= 60: return "ğŸ™‚"
    if score >= 50: return "âš ï¸"
    if score >= 40: return "âš ï¸"
    return "ğŸš«"

def get_penalty(respect, bad_count):
    penalty = 0
    if respect >= 76: penalty = bad_count // 2
    elif 71 <= respect <= 75: penalty = bad_count
    elif 61 <= respect <= 70: penalty = bad_count * 2
    elif 51 <= respect <= 60: penalty = bad_count * 3
    elif 41 <= respect <= 50: penalty = bad_count * 5
    elif 26 <= respect <= 40: penalty = bad_count * 10
    return penalty

def is_banned(user_id):
    if user_id in banned_users:
        if time.time() < banned_users[user_id]:
            return True
        else:
            del banned_users[user_id]
    return False

def add_to_log(user_id, sender, text):
    if user_id not in chat_logs:
        chat_logs[user_id] = []
    chat_logs[user_id].append((sender, text))
    if len(chat_logs[user_id]) > 50:
        chat_logs[user_id] = chat_logs[user_id][-50:]

# ===== Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø¦Ù…Ø© =====
def main_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"), KeyboardButton("ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"), KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø«"))
    return kb

# ===== Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
@bot.message_handler(commands=['start'])
def start(msg):
    uid = msg.from_user.id
    if is_banned(uid):
        bot.send_message(uid, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return
    if uid not in users:
        users[uid] = {"name": None, "age": None, "gender": None, "respect": 80, "gender_changed":0, "step":"name"}
        bot.send_message(uid, "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.\nÙ…Ø§ Ø§Ø³Ù…ÙƒØŸ", reply_markup=main_menu())
    else:
        users[uid]["step"] = None
        bot.send_message(uid, "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!", reply_markup=main_menu())

# ===== Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
@bot.message_handler(func=lambda m: users.get(m.from_user.id, {}).get("step")=="name")
def set_name(msg):
    uid = msg.from_user.id
    users[uid]["name"] = msg.text[:64]
    users[uid]["step"] = "age"
    bot.send_message(uid, "ğŸ‚ Ù…Ø§ Ù‡Ùˆ Ø¹Ù…Ø±ÙƒØŸ")

@bot.message_handler(func=lambda m: users.get(m.from_user.id, {}).get("step")=="age")
def set_age(msg):
    uid = msg.from_user.id
    if not msg.text.isdigit():
        bot.send_message(uid, "âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± ÙƒØ±Ù‚Ù….")
        return
    users[uid]["age"] = int(msg.text)
    users[uid]["step"] = "gender"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰")
    bot.send_message(uid, "ğŸš» Ø§Ø®ØªØ± Ø¬Ù†Ø³Ùƒ:", reply_markup=kb)

@bot.message_handler(func=lambda m: users.get(m.from_user.id, {}).get("step")=="gender")
def set_gender(msg):
    uid = msg.from_user.id
    if msg.text not in ["ğŸ‘¨ Ø°ÙƒØ±","ğŸ‘© Ø£Ù†Ø«Ù‰"]:
        bot.send_message(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.")
        return
    users[uid]["gender"] = "Ø°ÙƒØ±" if "Ø°ÙƒØ±" in msg.text else "Ø£Ù†Ø«Ù‰"
    users[uid]["step"] = None
    bot.send_message(uid, "âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ!", reply_markup=main_menu())

# ===== Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
@bot.message_handler(func=lambda m: m.text=="ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ")
def profile_menu(msg):
    uid = msg.from_user.id
    u = users.get(uid)
    if not u:
        bot.send_message(uid, "â„¹ï¸ Ø§ÙƒØªØ¨ /start Ø£ÙˆÙ„Ø§Ù‹.")
        return
    badge = get_respect_badge(u["respect"])
    info = f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {u['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {u['age']}\nâš§ï¸ Ø§Ù„Ø¬Ù†Ø³: {u['gender']}\nâ­ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {u['respect']} {badge}"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±", "ğŸš» ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(uid, info, reply_markup=kb)

# ===== Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =====
@bot.message_handler(func=lambda m: m.text=="ğŸ” Ø§Ù„Ø¨Ø­Ø«")
def search_menu(msg):
    uid = msg.from_user.id
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for t in TOPICS:
        kb.add(f"{t} ğŸ‘¨", f"{t} ğŸ‘©")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(uid, "Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙ†Ø§Ù‚Ø´ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ø§Ù„ ÙˆØ§Ù„Ø¬Ù†Ø³:", reply_markup=kb)

def find_partner(user_id, topic, target_gender):
    key = (topic, target_gender)
    opposite_gender = "Ø£Ù†Ø«Ù‰" if users[user_id]["gender"]=="Ø°ÙƒØ±" else "Ø°ÙƒØ±"
    partner_key = (topic, opposite_gender)
    if partner_key in waiting_users and waiting_users[partner_key]:
        partner_id = waiting_users[partner_key].pop(0)
        active_chats[user_id] = partner_id
        active_chats[partner_id] = user_id
        leave_timers[user_id] = time.time()
        leave_timers[partner_id] = time.time()
        # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        bot.send_message(user_id, f"ğŸ‰ ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ!\nğŸ‘¤ {users[partner_id]['name']}\nğŸ‚ {users[partner_id]['age']}\nâ­ {users[partner_id]['respect']}")
        bot.send_message(partner_id, f"ğŸ‰ ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ!\nğŸ‘¤ {users[user_id]['name']}\nğŸ‚ {users[user_id]['age']}\nâ­ {users[user_id]['respect']}")
        bot.send_message(user_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù† âœ…")
        bot.send_message(partner_id, "ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù† âœ…")
    else:
        if key not in waiting_users:
            waiting_users[key] = []
        waiting_users[key].append(user_id)
        bot.send_message(user_id, "â³ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒØŒ Ø³ÙŠØªÙ… Ù…Ø·Ø§Ø¨Ù‚ØªÙƒ Ù„Ø§Ø­Ù‚Ø§Ù‹.")

@bot.message_handler(func=lambda m: any(t in m.text for t in TOPICS))
def handle_topic_choice(msg):
    user_id = msg.from_user.id
    for t in TOPICS:
        if t in msg.text:
            target_gender = "Ø°ÙƒØ±" if "ğŸ‘¨" in msg.text else "Ø£Ù†Ø«Ù‰"
            find_partner(user_id, t, target_gender)
            break

# ===== Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
@bot.message_handler(func=lambda msg: True)
def relay(msg):
    user_id = msg.from_user.id
    text = msg.text
    if is_banned(user_id):
        bot.send_message(user_id, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return
    add_to_log(user_id, "me", text)
    if user_id in active_chats:
        partner_id = active_chats[user_id]
        add_to_log(partner_id, "partner", text)
        bot.send_message(partner_id, f"ğŸ’¬ {users[user_id]['name']}: {text}")
    else:
        bot.send_message(user_id, "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ù†Ø´Ø·ØŒ Ø§Ø¶ØºØ· ğŸ” Ø§Ù„Ø¨Ø­Ø«.")

# ===== Ø²Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© =====
@bot.message_handler(func=lambda msg: msg.text=="âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª")
def leave_chat(msg):
    user_id = msg.from_user.id
    if user_id not in active_chats:
        bot.send_message(user_id, "â„¹ï¸ Ù„Ø³Øª ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return
    elapsed = time.time() - leave_timers.get(user_id, 0)
    if elapsed < 30:
        bot.send_message(user_id, f"â³ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù‚Ø¨Ù„ 30 Ø«Ø§Ù†ÙŠØ©. ØªØ¨Ù‚Ù‰ {int(30-elapsed)} Ø«Ø§Ù†ÙŠØ©.")
        return
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ğŸšª", callback_data=f"confirm_leave_{user_id}"))
    bot.send_message(user_id, "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith("confirm_leave_"))
def confirm_leave(call):
    user_id = int(call.data.split("_")[-1])
    if user_id not in active_chats:
        bot.answer_callback_query(call.id, "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ.")
        return
    partner_id = active_chats[user_id]
    bot.send_message(user_id, "ğŸšª ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    bot.send_message(partner_id, "ğŸšª Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    for uid in [user_id, partner
