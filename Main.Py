import os
import time
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
TOKEN = os.environ.get("TELEGRAM_TOKEN")  # Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ø¯Ø§Ø®Ù„ Render
if not TOKEN:
    raise RuntimeError("Ø¶Ø¹ TELEGRAM_TOKEN ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¹Ù„Ù‰ Render")

bot = telebot.TeleBot(TOKEN)

# ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© =====
users = {}            # user_id -> {name, gender, age, respect, gender_changes, step, topic}
active_chats = {}     # user_id -> partner_id
leave_timers = {}     # user_id -> timestamp when chat started

TOPICS = ["ğŸ“š ÙÙ„Ø³ÙØ©", "âš½ Ø±ÙŠØ§Ø¶Ø©", "â˜ªï¸ Ø¯ÙŠÙ†", "ğŸ—³ï¸ Ø³ÙŠØ§Ø³Ø©", "ğŸ¤ ØªØ¹Ø§Ø±Ù"]
GENDER_BTNS = ["ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰"]

# ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def get_respect_badge(score: int) -> str:
    if score >= 80:
        return "ğŸŒŸ"
    if score >= 60:
        return "ğŸ™‚"
    if score >= 40:
        return "âš ï¸"
    return "ğŸš«"

# ===== Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
@bot.message_handler(commands=["start"])  # /start
def start(message):
    uid = message.chat.id
    users.setdefault(uid, {
        "name": message.from_user.first_name or "" ,
        "gender": None,
        "age": None,
        "respect": 80,
        "gender_changes": 0,
        "step": "gender",
        "topic": None
    })
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for g in GENDER_BTNS:
        kb.add(KeyboardButton(g))
    bot.send_message(uid, "ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§! Ù…Ø§ Ù‡Ùˆ Ø¬Ù†Ø³ÙƒØŸ", reply_markup=kb)

# ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³ =====
@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "gender")
def set_gender(message):
    uid = message.chat.id
    txt = message.text
    if txt not in GENDER_BTNS:
        return bot.send_message(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.")
    users[uid]["gender"] = "Ø°ÙƒØ±" if "Ø°ÙƒØ±" in txt else "Ø£Ù†Ø«Ù‰"
    users[uid]["step"] = "age"
    bot.send_message(uid, "ğŸ‚ ÙƒÙ… Ø¹Ù…Ø±ÙƒØŸ", reply_markup=ReplyKeyboardRemove())

# ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ø± =====
@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "age")
def set_age(message):
    uid = message.chat.id
    if not message.text.isdigit():
        return bot.send_message(uid, "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø± ÙƒØ±Ù‚Ù….")
    users[uid]["age"] = int(message.text)
    users[uid]["step"] = None
    bot.send_message(uid, "âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ!\nØ§ÙƒØªØ¨ ğŸ‘‰ /Ø¨Ø­Ø« Ù„Ù„Ø¨Ø¯Ø¡ Ø£Ùˆ ğŸ‘‰ /Ù…Ù„ÙÙŠ Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.")

# ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
@bot.message_handler(commands=["Ù…Ù„ÙÙŠ"])  # /Ù…Ù„ÙÙŠ
def my_profile(message):
    uid = message.chat.id
    u = users.get(uid)
    if not u:
        return bot.send_message(uid, "â„¹ï¸ Ø§ÙƒØªØ¨ /start Ø£ÙˆÙ„Ø§Ù‹.")
    badge = get_respect_badge(u.get("respect", 80))
    bot.send_message(uid,
        f"ğŸ“Š Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ:\n"
        f"â€¢ Ø§Ù„Ø§Ø³Ù…: {u.get('name') or 'â€”'}\n"
        f"â€¢ Ø§Ù„Ø¬Ù†Ø³: {u.get('gender') or 'â€”'}\n"
        f"â€¢ Ø§Ù„Ø¹Ù…Ø±: {u.get('age') or 'â€”'}\n"
        f"â€¢ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {u.get('respect', 80)} {badge}\n\n"
        f"Ø§ÙƒØªØ¨ /ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ /Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ.")

# ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
@bot.message_handler(commands=["ØªØ¹Ø¯ÙŠÙ„"])  # /ØªØ¹Ø¯ÙŠÙ„
def edit_menu(message):
    uid = message.chat.id
    if uid not in users:
        return bot.send_message(uid, "â„¹ï¸ Ø§ÙƒØªØ¨ /start Ø£ÙˆÙ„Ø§Ù‹.")
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"))
    kb.add(KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸš» ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³"))
    users[uid]["step"] = "edit_menu"
    bot.send_message(uid, "ğŸ› ï¸ Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ¹Ø¯Ù„ØŸ", reply_markup=kb)

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "edit_menu")
def handle_edit_choice(message):
    uid = message.chat.id
    choice = message.text
    if choice == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        users[uid]["step"] = "edit_name"
        bot.send_message(uid, "Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", reply_markup=ReplyKeyboardRemove())
    elif choice == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        users[uid]["step"] = "edit_age"
        bot.send_message(uid, "Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙƒØ±Ù‚Ù…:", reply_markup=ReplyKeyboardRemove())
    elif choice == "ğŸš» ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³":
        # Ù…Ø³Ù…ÙˆØ­ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        if users[uid].get("gender_changes", 0) >= 1:
            return bot.send_message(uid, "ğŸš« Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ù†Ø³ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©. Ø§Ù„Ù…ØµØ¯Ø§Ù‚ÙŠØ© Ù…Ù‡Ù…Ø© Ø¹Ù†Ø¯Ù†Ø§ â¤ï¸")
        # ØªØ­Ø°ÙŠØ± Ù„Ø·ÙŠÙ
        bot.send_message(uid, "ğŸ˜… Ø¥Ø°Ø§ ÙƒÙ†Øª Ø°ÙƒØ± Ø®Ù„ÙŠÙƒ Ø°ÙƒØ±ØŒ Ù„Ø§ ØªØªØ­ÙˆÙ„ Ø±Ø¬Ø§Ø¡Ù‹.. ÙØ±ÙŠÙ‚Ù†Ø§ Ù†Ø§Ù‚Øµ ğŸ˜‚")
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        for g in GENDER_BTNS:
            kb.add(KeyboardButton(g))
        users[uid]["step"] = "edit_gender"
        bot.send_message(uid, "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³:", reply_markup=kb)
    else:
        bot.send_message(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.")

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "edit_name")
def do_edit_name(message):
    uid = message.chat.id
    users[uid]["name"] = message.text.strip()[:64]
    users[uid]["step"] = None
    bot.send_message(uid, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù….", reply_markup=ReplyKeyboardRemove())

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "edit_age")
def do_edit_age(message):
    uid = message.chat.id
    if not message.text.isdigit():
        return bot.send_message(uid, "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø± ÙƒØ±Ù‚Ù….")
    users[uid]["age"] = int(message.text)
    users[uid]["step"] = None
    bot.send_message(uid, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ø±.", reply_markup=ReplyKeyboardRemove())

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "edit_gender")
def do_edit_gender(message):
    uid = message.chat.id
    txt = message.text
    if txt not in GENDER_BTNS:
        return bot.send_message(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.")
    users[uid]["gender"] = "Ø°ÙƒØ±" if "Ø°ÙƒØ±" in txt else "Ø£Ù†Ø«Ù‰"
    users[uid]["gender_changes"] = users[uid].get("gender_changes", 0) + 1
    users[uid]["step"] = None
    bot.send_message(uid, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù†Ø³.", reply_markup=ReplyKeyboardRemove())

# ===== Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =====
@bot.message_handler(commands=["Ø¨Ø­Ø«"])  # /Ø¨Ø­Ø«
def choose_topic(message):
    uid = message.chat.id
    u = users.get(uid)
    if not u or not u.get("gender") or not u.get("age"):
        return bot.send_message(uid, "â„¹ï¸ Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± /start")
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for t in TOPICS:
        kb.add(KeyboardButton(t))
    users[uid]["step"] = "topic"
    bot.send_message(uid, "ğŸ’¬ Ø¹Ù† Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØªØ­Ø¯Ø« Ø§Ù„ÙŠÙˆÙ…ØŸ", reply_markup=kb)

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "topic")
def topic_selected(message):
    uid = message.chat.id
    if message.text not in TOPICS:
        return bot.send_message(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·.")
    users[uid]["topic"] = message.text
    users[uid]["step"] = "search_gender"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø¬Ù„ ğŸ‘¨"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØªØ§Ø© ğŸ‘©"))
    bot.send_message(uid, "ğŸ‘¥ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±ÙŠÙƒ:", reply_markup=kb)

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "search_gender")
def do_search(message):
    uid = message.chat.id
    choice = message.text
    if choice not in ["ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø¬Ù„ ğŸ‘¨", "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØªØ§Ø© ğŸ‘©"]:
        return bot.send_message(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.")
    desired_gender = "Ø°ÙƒØ±" if "Ø±Ø¬Ù„" in choice else "Ø£Ù†Ø«Ù‰"
    my_topic = users[uid]["topic"]

    # Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Ù…Ù†Ø§Ø³Ø¨
    for other_id, data in users.items():
        if other_id == uid:
            continue
        if other_id in active_chats or uid in active_chats:
            continue
        if data.get("topic") == my_topic and data.get("gender") == desired_gender:
            # Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø«Ù†ÙŠÙ†
            active_chats[uid] = other_id
            active_chats[other_id] = uid
            leave_timers[uid] = time.time()
            leave_timers[other_id] = time.time()

            kb = ReplyKeyboardMarkup(resize_keyboard=True)
            kb.add(KeyboardButton("âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª"))
            bot.send_message(other_id, "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ! ğŸ‰ Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†.", reply_markup=kb)
            bot.send_message(uid, "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ! ğŸ‰ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†.", reply_markup=kb)
            users[uid]["step"] = None
            users[other_id]["step"] = None
            return

    bot.send_message(uid, "ğŸ” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.")

# ===== Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© =====
@bot.message_handler(func=lambda m: m.text == "âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª")
def leave_chat(message):
    uid = message.chat.id
    if uid not in active_chats:
        return bot.send_message(uid, "â„¹ï¸ Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
    if time.time() - leave_timers.get(uid, 0) < 30:
        return bot.send_message(uid, "â³ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 30 Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")

    partner = active_chats[uid]
    bot.send_message(partner, "ğŸšª ØºØ§Ø¯Ø± Ø´Ø±ÙŠÙƒÙƒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    bot.send_message(uid, "ğŸšª ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©. Ø§ÙƒØªØ¨ ğŸ‘‰ /Ø¨Ø­Ø« Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.", reply_markup=ReplyKeyboardRemove())

    # Ù†Ø¸Ù‘Ù Ø§Ù„Ø±Ø¨Ø· Ù„Ù„Ø·Ø±ÙÙŠÙ†
    for x in (uid, partner):
        active_chats.pop(x, None)
        leave_timers.pop(x, None)

# ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙŠÙƒÙŠÙ† =====
@bot.message_handler(func=lambda m: True)
def relay(message):
    uid = message.chat.id
    if uid in active_chats:
        partner = active_chats[uid]
        sender_name = users.get(uid, {}).get("name") or "Ù…Ø³ØªØ®Ø¯Ù…"
        bot.send_message(partner, f"ğŸ’¬ {sender_name}: {message.text}")
    else:
        u = users.get(uid)
        if u and u.get("step") is None:
            bot.send_message(uid, "â„¹ï¸ Ø§ÙƒØªØ¨ ğŸ‘‰ /Ø¨Ø­Ø« Ù„Ù„Ø¨Ø¯Ø¡.")

# ===== ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª (Polling) =====
if __name__ == "__main__":
    # infinity_polling Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±Ø§Øª
    bot.infinity_polling(skip_pending=True, timeout=20, long_polling_timeout=20)
