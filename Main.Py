# Main.py (Ù…ØµØ­Ø­ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„)
import os
import time
import traceback
import importlib
from flask import Flask, request
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, Message

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ±Ø³Ø§Ø¦Ù„ ÙˆØ³ØªÙŠÙƒØ±Ø§Øª
config = importlib.import_module("config")
from messages import (
    delayed_send, get_welcome_message, WELCOME, HELP, SEARCHING, NO_MATCH, 
    INTRO_PARTNER, LEAVE_CONFIRM, LEAVE_TOO_SOON, LEFT_YOU, LEFT_PARTNER, 
    REPORT_CONFIRM, REPORT_OK, REPORT_RESULT, MUTED, BANNED, PROFILE_SAVED
)
from stickers import STICKERS

# Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
import storage
from storage import users, load_users, save_users, ensure_user, update_user_dict, append_history
import Profile_manger as ProfileManager

# Matchmaking + Moderation (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© fallbacks)
try:
    from Matchmaking import add_to_wait, try_match, start_timeout_watcher, remove_from_wait
except Exception as e:
    print(f"[IMPORT Matchmaking ERROR] {e}")
    def add_to_wait(*args, **kwargs): 
        raise RuntimeError("Matchmaking.add_to_wait unavailable")
    def try_match(*args, **kwargs): return None
    def start_timeout_watcher(bot=None): return
    def remove_from_wait(*args, **kwargs): return

try:
    from Moderation import is_muted, apply_respect, review_history_and_penalize, check_message_safe, contains_bad_word, censor_text
except Exception as e:
    print(f"[IMPORT Moderation ERROR] {e}")
    # fallbacks
    def is_muted(uid): return False
    def apply_respect(uid, text): return 0
    def review_history_and_penalize(uid, pid, history): return (0,0,0,0)
    def check_message_safe(text): return True
    def contains_bad_word(text): return []
    def censor_text(text): return text

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª
TOKEN = os.environ.get("TELEGRAM_TOKEN") or os.environ.get("BOT_TOKEN") or (getattr(config, "TOKEN", None) if hasattr(config, "TOKEN") else None)
if not TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN / BOT_TOKEN ØºÙŠØ± Ù…Ø¹Ø±Ù ÙÙŠ environment Ø£Ùˆ config.TOKEN")

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")
app = Flask(__name__)

# Ø«ÙˆØ§Ø¨Øª Ø­Ø§Ù„Ø§Øª
STATE_REGISTER_NAME = "REGISTER_NAME"
STATE_REGISTER_GENDER = "REGISTER_GENDER"
STATE_REGISTER_AGE = "REGISTER_AGE"
STATE_EDIT_NAME = "EDIT_NAME"
STATE_EDIT_AGE = "EDIT_AGE"
STATE_CHOOSE_TOPIC = "CHOOSE_TOPIC"
STATE_CHOOSE_TARGET_GENDER = "CHOOSE_TARGET_GENDER"
STATE_SEARCHING = "SEARCHING"
STATE_CONFIRM_LEAVE = "CONFIRM_LEAVE"
STATE_CONFIRM_REPORT = "CONFIRM_REPORT"

# ÙƒÙŠØ¨ÙˆØ±Ø¯Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
def main_menu(in_chat: bool = False) -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¤ Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"), KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"))
    if in_chat:
        kb.add(KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"), KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    kb.add(KeyboardButton("ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…"))
    return kb

def topics_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    try:
        TOPICS = getattr(config, "TOPICS", ["Ø¹Ø§Ù…"])
        for i in range(0, len(TOPICS), 2):
            row = [KeyboardButton(TOPICS[i])]
            if i+1 < len(TOPICS):
                row.append(KeyboardButton(TOPICS[i+1]))
            kb.add(*row)
    except Exception:
        kb.add(KeyboardButton("Ø¹Ø§Ù…"))
    return kb

def gender_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for g in getattr(config, "GENDERS", ["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰"]):
        kb.add(KeyboardButton(g))
    return kb

def target_gender_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for tg in getattr(config, "TARGET_GENDERS", ["ğŸ‘¨ Ø±Ø¬Ù„", "ğŸ‘© Ø§Ù…Ø±Ø£Ø©"]):
        kb.add(KeyboardButton(tg))
    return kb

def yes_no_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("Ù†Ø¹Ù… âœ…"), KeyboardButton("Ù„Ø§ âŒ"))
    return kb

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
try:
    load_users()
except Exception as e:
    print(f"[LOAD_USERS ERROR] {e}")

# Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
def ensure_user_extended(uid: int):
    u = ensure_user(uid)
    if "points" not in u:
        u["points"] = u.get("points", 100)
    if "referrer" not in u:
        u["referrer"] = u.get("referrer", None)
    if "referral_code" not in u:
        u["referral_code"] = u.get("referral_code", None)
    if "state" not in u:
        u["state"] = None
    u.setdefault("partner", None)
    u.setdefault("history", [])
    save_users()
    return u

# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
def update_user(uid: int, updates: dict):
    try:
        update_user_dict(uid, updates)
    except Exception as e:
        print(f"[UPDATE_USER ERROR] {e} | uid={uid} | updates={updates}")
        print(traceback.format_exc())

def safe_send(uid: int, text: str, **kwargs):
    try:
        delayed_send(bot, uid, text, **kwargs)
    except Exception:
        try:
            bot.send_message(uid, text, **kwargs)
        except Exception as e:
            print(f"[SEND ERROR] {e} | uid={uid} | preview={str(text)[:120]}")

def safe_send_sticker(uid: int, sticker_id: str):
    try:
        bot.send_sticker(uid, sticker_id)
    except Exception as e:
        print(f"[STICKER ERROR] {e} | uid={uid} | sticker={sticker_id}")

def partner_profile_text(pid: int):
    try:
        p = users.get(pid)
        if not p:
            return "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©."
        name = p.get("name") or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
        age = p.get("age") or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
        gender = p.get("gender") or "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
        respect = p.get("respect", 80)
        return f"ğŸ‘¤ <b>ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ Ù„Ùƒ</b>\nâ€¢ Ø§Ù„Ø§Ø³Ù…: {name}\nâ€¢ Ø§Ù„Ø¹Ù…Ø±: {age}\nâ€¢ Ø§Ù„Ø¬Ù†Ø³: {gender}\nâ€¢ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: â­ {respect}"
    except Exception as e:
        print(f"[partner_profile_text ERROR] {e}")
        return "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©."

# Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±
@bot.message_handler(commands=['start'])
def cmd_start(message: Message):
    uid = message.from_user.id
    u = ensure_user_extended(uid)

    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ø£Ùˆ Ù„Ù… ÙŠÙØ³Ø¬Ù„ Ø§Ø³Ù…Ù‡
    if not u.get("name"):
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        welcome_msg = get_welcome_message("START")
        safe_send(uid, welcome_msg)
        
        # Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³ØªÙŠÙƒØ± Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠ
        safe_send_sticker(uid, STICKERS.get("welcome_general"))

        # Ø¨Ø¯Ø¡ Ø®Ø·ÙˆØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù…
        update_user(uid, {"state": STATE_REGISTER_NAME})
        safe_send(uid, "ğŸ’¡ Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.\nÙ…Ø§ Ù‡Ùˆ Ø§Ø³Ù…ÙƒØŸ")
    else:
        # Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ÙŠÙ…ØŒ Ù†Ø±Ø­Ø¨ Ø¨Ù‡ Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø±Ø¦ÙŠØ³ÙŠØ©
        safe_send(uid, f"ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ø¬Ø¯Ø¯Ù‹Ø§ØŒ {u.get('name')}!", 
                 reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["profile"])
def cmd_profile(m: Message):
    uid = m.from_user.id
    ensure_user_extended(uid)
    u = users[uid]
    safe_send(uid, ProfileManager.profile_text(u), 
             reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["help", "support"])
def cmd_support(m: Message):
    uid = m.from_user.id
    ensure_user_extended(uid)
    support_handle = "@MAA2857"
    safe_send(uid, f"Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø±: {support_handle}\nØ£Ùˆ Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§ ÙˆØ³Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø±Ø¯ Ø¥Ù† Ø£Ù…ÙƒÙ†.")

@bot.message_handler(commands=["search", "chat", "find"])
def cmd_search(m: Message):
    uid = m.from_user.id
    handle_search_request(uid)

@bot.message_handler(commands=["leave", "exit"])
def cmd_leave(m: Message):
    uid = m.from_user.id
    handle_leave_request(uid)

@bot.message_handler(commands=["report"])
def cmd_report(m: Message):
    uid = m.from_user.id
    ensure_user_extended(uid)
    update_user(uid, {"state": STATE_CONFIRM_REPORT})
    safe_send(uid, REPORT_CONFIRM, reply_markup=yes_no_menu())

# Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Øµ - Ù‡Ù†Ø§ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ§Ù„Ø­Ù„
# Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø­Ø³Ù†

@bot.message_handler(func=lambda msg: True, content_types=["text"])
def on_text(m: Message):
    uid = m.from_user.id
    txt = (m.text or "").strip()
    
    # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    ensure_user_extended(uid)
    u = users[uid]
    
    if u.get("banned_full"):
        safe_send(uid, BANNED)
        return
        
    state = u.get("state") or ""
    print(f"[MSG DEBUG] from={uid} state='{state}' text='{txt[:50]}...'")

    # **Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ - Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ**
    if state == STATE_REGISTER_NAME:
        print(f"[DEBUG] Processing register name for uid={uid}")
        handle_register_name(uid, txt)
        return
    elif state == STATE_REGISTER_GENDER:
        print(f"[DEBUG] Processing register gender for uid={uid}")
        handle_register_gender(uid, txt)
        return
    elif state == STATE_REGISTER_AGE:
        print(f"[DEBUG] Processing register age for uid={uid}")
        handle_register_age(uid, txt)
        return

    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    elif state == STATE_EDIT_NAME:
        handle_edit_name(uid, txt)
        return
    elif state == STATE_EDIT_AGE:
        handle_edit_age(uid, txt)
        return

    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¨Ø­Ø«
    elif state == STATE_CHOOSE_TOPIC:
        handle_topic_selection(uid, txt)
        return
    elif state == STATE_CHOOSE_TARGET_GENDER:
        handle_target_gender(uid, txt)
        return

    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ£ÙƒÙŠØ¯
    elif state == STATE_CONFIRM_LEAVE:
        handle_leave_confirm(uid, u, txt)
        return
    elif state == STATE_CONFIRM_REPORT:
        handle_report_text_confirm(uid, u, txt)
        return

    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¹Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª)
    if txt == "ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…":
        support_handle = "@MAA2857"
        safe_send(uid, f"Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…: {support_handle}\nØ£Ø®Ø¨Ø±Ù†Ø§ Ø¨Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ³Ù†Ø±Ø§Ø¬Ø¹Ù‡Ø§.")
        return

    if txt == "ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©":
        handle_leave_request(uid)
        return
    if txt == "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº":
        update_user(uid, {"state": STATE_CONFIRM_REPORT})
        safe_send(uid, REPORT_CONFIRM, reply_markup=yes_no_menu())
        return

    # Ù‚Ø§Ø¦Ù…Ø© Ø±Ø¦ÙŠØ³ÙŠØ©
    if txt == "ğŸ‘¤ Ù…Ù„ÙÙŠ":
        safe_send(uid, ProfileManager.profile_text(u), 
                 reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return
    elif txt == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        update_user(uid, {"state": STATE_EDIT_NAME})
        safe_send(uid, "âœï¸ Ø£Ø±Ø³Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", reply_markup=ReplyKeyboardRemove())
        return
    elif txt == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        update_user(uid, {"state": STATE_EDIT_AGE})
        safe_send(uid, "ğŸ‚ Ø£Ø±Ø³Ù„ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (10â€“120):", reply_markup=ReplyKeyboardRemove())
        return
    elif txt == "ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©":
        support_handle = "@MAA2857"
        safe_send(uid, f"ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…: {support_handle}")
        return
    elif txt == "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©":
        handle_search_request(uid)
        return

    # Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø¯Ø±Ø¯Ø´Ø©
    if u.get("partner"):
        handle_chat_message(uid, txt, u)
        return

    # Ø§ÙØªØ±Ø§Ø¶ÙŠ - Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ state ÙˆÙ„Ø§ partner
    safe_send(uid, "â” Ù„Ù… Ø£ÙÙ‡Ù…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„.", 
             reply_markup=main_menu(in_chat=False))

# ---------- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù…Ø¨Ø³Ø·Ø© Ø¨Ø¯ÙˆÙ† next_step_handler) ----------

def handle_register_name(uid: int, txt: str):
    print(f"[REGISTER_NAME] uid={uid}, text={txt}")
    
    if len(txt) < 2 or len(txt) > 30:
        safe_send(uid, "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­ØŒ Ø§Ø³ØªØ®Ø¯Ù… 2â€“30 Ø­Ø±ÙÙ‹Ø§. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")
        return

    try:
        # Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…
        ProfileManager.set_name(uid, txt)
        
        # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³
        update_user(uid, {"state": STATE_REGISTER_GENDER})
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø³ØªÙŠÙƒØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù…
        safe_send_sticker(uid, STICKERS.get("after_name"))
        
        # Ø·Ù„Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³
        safe_send(uid, "ğŸ’¡ Ø§Ø®ØªØ± Ø¬Ù†Ø³Ùƒ:", reply_markup=gender_menu())
        
        print(f"[REGISTER_NAME] Success for uid={uid}")
        
    except Exception as e:
        print(f"[handle_register_name ERROR] {e}")
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")

def handle_register_gender(uid: int, txt: str):
    print(f"[REGISTER_GENDER] uid={uid}, text={txt}")
    
    valid_genders = getattr(config, "GENDERS", ["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰"])
    if txt not in valid_genders:
        safe_send(uid, f"âŒ Ø§Ø®ØªØ± Ø¬Ù†Ø³Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§: {' / '.join(valid_genders)}", 
                 reply_markup=gender_menu())
        return

    try:
        # Ø­ÙØ¸ Ø§Ù„Ø¬Ù†Ø³
        ProfileManager.set_gender(uid, txt)
        
        # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø­Ø§Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø±
        update_user(uid, {"state": STATE_REGISTER_AGE})
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø±
        safe_send(uid, "ğŸ‚ Ù…Ø§ Ø¹Ù…Ø±ÙƒØŸ (10â€“120)", reply_markup=ReplyKeyboardRemove())
        
        print(f"[REGISTER_GENDER] Success for uid={uid}")
        
    except Exception as e:
        print(f"[handle_register_gender ERROR] {e}")
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ù†Ø³. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")

def handle_register_age(uid: int, txt: str):
    print(f"[REGISTER_AGE] uid={uid}, text={txt}")
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù…
    try:
        age = int(txt)
    except ValueError:
        safe_send(uid, "âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± ÙƒØ±Ù‚Ù… Ø¨ÙŠÙ† 10 Ùˆ120:")
        return

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù…Ø± Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ
    if age < 10 or age > 120:
        safe_send(uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠ. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (10â€“120):")
        return

    try:
        # Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ø±
        ProfileManager.set_age(uid, age)
        
        # Ø¥Ù†Ù‡Ø§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        update_user(uid, {"state": None})
        
        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙŠØ«
        u = storage.users.get(uid, {})
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        safe_send(uid, PROFILE_SAVED.format(
            name=u.get("name", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"),
            gender=u.get("gender", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"),
            age=u.get("age", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯")
        ), reply_markup=main_menu(in_chat=False))
        
        print(f"[REGISTER_AGE] Success for uid={uid}")
        
    except Exception as e:
        print(f"[handle_register_age ERROR] {e}")
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ø±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")

# ---------- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ----------

def handle_edit_name(uid: int, txt: str):
    try:
        if len(txt) < 2 or len(txt) > 30:
            safe_send(uid, "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­ (2-30 Ø­Ø±Ù). Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§:")
            return
            
        ProfileManager.set_name(uid, txt)
        update_user(uid, {"state": None})
        safe_send(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰: {txt}", 
                 reply_markup=main_menu(in_chat=False))
    except Exception as e:
        print(f"[handle_edit_name ERROR] {e}")
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù….")

def handle_edit_age(uid: int, txt: str):
    try:
        age = int(txt)
        if age < 10 or age > 120:
            safe_send(uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:")
            return
            
        ProfileManager.set_age(uid, age)
        update_user(uid, {"state": None})
        safe_send(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ø± Ø¥Ù„Ù‰: {age}", 
                 reply_markup=main_menu(in_chat=False))
    except Exception as e:
        print(f"[handle_edit_age ERROR] {e}")
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±.")

def handle_search_request(uid: int):
    ensure_user_extended(uid)
    u = users[uid]
    if u.get("partner"):
        safe_send(uid, "âš ï¸ Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø©!", 
                 reply_markup=main_menu(in_chat=True))
        return
    update_user(uid, {"state": STATE_CHOOSE_TOPIC})
    safe_send(uid, "Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø´:", reply_markup=topics_menu())

def handle_topic_selection(uid: int, txt: str):
    try:
        TOPICS = getattr(config, "TOPICS", ["Ø¹Ø§Ù…"])
    except Exception:
        TOPICS = ["Ø¹Ø§Ù…"]
    
    if txt not in TOPICS:
        safe_send(uid, "âŒ Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", reply_markup=topics_menu())
        return
        
    update_user(uid, {"topic": txt, "state": STATE_CHOOSE_TARGET_GENDER})
    safe_send(uid, f"ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: {txt}\nØ§Ù„Ø¢Ù† Ø§Ø®ØªØ± Ø¬Ù†Ø³ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡:", 
             reply_markup=target_gender_menu())

def handle_target_gender(uid: int, txt: str):
    valid = getattr(config, "TARGET_GENDERS", ["ğŸ‘¨ Ø±Ø¬Ù„", "ğŸ‘© Ø§Ù…Ø±Ø£Ø©"])
    if txt not in valid:
        safe_send(uid, f"âŒ Ø§Ø®ØªØ±: {' / '.join(valid)}", reply_markup=target_gender_menu())
        return

    if "Ø±Ø¬Ù„" in txt:
        target = "male"
    elif "Ø§Ù…Ø±Ø£Ø©" in txt or "Ø§Ù…Ø±Ø£" in txt:
        target = "female"
    else:
        target = "any"

    u = users[uid]
    topic = u.get("topic")
    update_user(uid, {"target_gender": target, "state": STATE_SEARCHING})
    
    # Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    try:
        add_to_wait(topic, uid, target)
    except Exception as e:
        print(f"[add_to_wait ERROR] {e}")

    # Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
    safe_send(uid, SEARCHING, reply_markup=ReplyKeyboardRemove())

    # Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙˆØ±Ø§Ù‹
    partner = None
    try:
        partner = try_match(uid, topic)
    except Exception as e:
        print(f"[try_match ERROR] {e}")

    if partner:
        try:
            pid = int(partner)
            update_user(uid, {"partner": pid, "state": None, "chat_started_at": time.time()})
            update_user(pid, {"partner": uid, "state": None, "chat_started_at": time.time()})
            
            ProfileManager.start_history(users[uid])
            ProfileManager.start_history(users[pid])
            
            safe_send(uid, partner_profile_text(pid), reply_markup=ReplyKeyboardRemove())
            safe_send(pid, partner_profile_text(uid), reply_markup=ReplyKeyboardRemove())
            safe_send(uid, INTRO_PARTNER, reply_markup=main_menu(in_chat=True))
            safe_send(pid, INTRO_PARTNER, reply_markup=main_menu(in_chat=True))
        except Exception as e:
            print(f"[MATCH SETUP ERROR] {e}")

    try:
        start_timeout_watcher(bot)
    except Exception as e:
        print(f"[start_timeout_watcher ERROR] {e}")

def handle_leave_request(uid: int):
    ensure_user_extended(uid)
    u = users[uid]
    started = u.get("chat_started_at") or 0
    elapsed = time.time() - started
    leave_delay = getattr(config, "LEAVE_DELAY", 30)
    if elapsed < leave_delay:
        safe_send(uid, LEAVE_TOO_SOON.format(remain=int(leave_delay - elapsed)))
        return
    update_user(uid, {"state": STATE_CONFIRM_LEAVE})
    safe_send(uid, LEAVE_CONFIRM, reply_markup=yes_no_menu())

def handle_leave_confirm(uid: int, u: dict, txt: str):
    if txt == "Ù†Ø¹Ù… âœ…":
        pid = u.get("partner")
        if pid:
            try:
                ProfileManager.end_session(users[uid], users[pid])
            except Exception:
                pass
                
            update_user(uid, {"partner": None, "state": None, "chat_started_at": None})
            update_user(pid, {"partner": None, "state": None, "chat_started_at": None})
            
            safe_send(uid, "Ù„Ù‚Ø¯ ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", reply_markup=main_menu(in_chat=False))
            
            try:
                safe_send_sticker(pid, STICKERS.get("partner_left"))
                safe_send(pid, "Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", reply_markup=main_menu(in_chat=False))
            except Exception:
                pass
        else:
            update_user(uid, {"state": None})
            safe_send(uid, "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠ.")
    elif txt == "Ù„Ø§ âŒ":
        update_user(uid, {"state": None})
        safe_send(uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. ØªØ§Ø¨Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ‘Œ")
    else:
        safe_send(uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", reply_markup=yes_no_menu())

def handle_report_text_confirm(uid: int, u: dict, txt: str):
    if txt == "Ù†Ø¹Ù… âœ…":
        pid = u.get("partner")
        try:
            hist = []
            if pid and users.get(pid):
                hist = users[pid].get("history", [])
            res = review_history_and_penalize(uid, pid, hist)
            lines, badwords, penalty, new_respect = res
        except Exception as e:
            print(f"[review_history_and_penalize ERROR] {e}")
            res = (0,0,0, users.get(pid, {}).get("respect", "â€”") if pid else "â€”")
            lines, badwords, penalty, new_respect = res
            
        update_user(uid, {"state": None})
        safe_send(uid, REPORT_OK)
        safe_send(uid, REPORT_RESULT.format(
            lines=lines, badwords=badwords, penalty=penalty, new_respect=new_respect
        ))
        
        # Ø£Ø®Ø¨Ø± Ø§Ù„Ø´Ø±ÙŠÙƒ Ø¥Ù† ÙˆÙØ¬Ø¯
        try:
            if pid:
                safe_send(pid, f"ğŸ”” ØªÙ… ØªÙ„Ù‚ÙŠ Ø¨Ù„Ø§Øº Ø¶Ø¯Ùƒ. ØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ®ØµÙ… {penalty} Ù†Ù‚Ø·Ø© Ø§Ø­ØªØ±Ø§Ù…. Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„Ø¢Ù†: {new_respect}.")
        except Exception:
            pass
            
    elif txt == "Ù„Ø§ âŒ":
        update_user(uid, {"state": None})
        safe_send(uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒ.")
    else:
        safe_send(uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", reply_markup=yes_no_menu())
        return
        
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    safe_send(uid, "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¢Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŸ", reply_markup=kb)

def handle_chat_message(uid: int, txt: str, u: dict):
    if txt in ("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©", "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº", "ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…"):
        return

    # ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø¬Ø²Ø¦ÙŠ
    if u.get("muted_until") and time.time() < int(u.get("muted_until")):
        left = int(int(u.get("muted_until")) - time.time())
        safe_send(uid, MUTED.format(left=left))
        return

    try:
        bad = contains_bad_word(txt)
        if bad:
            txt_to_send = censor_text(txt)
            safe_send(uid, "âš ï¸ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ø§Ø­ØªÙˆØ§Ø¦Ù‡Ø§ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©.")
        else:
            txt_to_send = txt
    except Exception:
        txt_to_send = txt

    try:
        apply_respect(uid, txt_to_send)
    except Exception:
        pass

    try:
        append_history(uid, txt_to_send)
    except Exception:
        pass

    pid = u.get("partner")
    if not pid or pid not in users:
        update_user(uid, {"partner": None})
        safe_send(uid, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠ â€” Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", reply_markup=main_menu(in_chat=False))
        return

    try:
        bot.send_message(pid, f"ğŸ’¬ {txt_to_send}")
    except Exception as e:
        print(f"[SEND TO PARTNER ERROR] {e}")
        safe_send(uid, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠÙƒ.")

# Webhook endpoint
@app.route(f"/{getattr(config, 'WEBHOOK_PATH', 'webhook')}", methods=["POST"])
def webhook():
    try:
        json_str = request.get_data().decode("utf-8")
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        print(f"[WEBHOOK PROCESS ERROR] {e}\n{traceback.format_exc()}")
    return "", 200

def set_webhook():
    url = getattr(config, "WEBHOOK_URL", None)
    path = getattr(config, "WEBHOOK_PATH", "webhook")
    if not url:
        print("[WEBHOOK] WEBHOOK_URL not set; skipping webhook setup")
        return
    try:
        bot.remove_webhook()
    except Exception:
        pass
    bot.set_webhook(f"{url}/{path}")
    print(f"[WEBHOOK] Set to {url}/{path}")

# Ø´ØºÙ„ watcher Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
try:
    start_timeout_watcher(bot)
except Exception as e:
    print(f"[start_timeout_watcher ERROR] {e}")

# Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
if __name__ == "__main__":
    try:
        load_users()
    except Exception as e:
        print(f"[LOAD_USERS ERROR] {e}")
    try:
        set_webhook()
    except Exception as e:
        print(f"[WEBHOOK ERROR] {e}")
    port = int(os.environ.get("PORT", getattr(config, "PORT", 5000)))
    print(f"[RUN] Webhook listening on port {port}â€¦")
    app.run(host="0.0.0.0", port=port)
