# main.py
import time
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, Message

from config import TOKEN, ADMIN_CHAT_ID, TOPICS, GENDERS, TARGET_GENDERS, LEAVE_DELAY
from storage import load_users, save_users, ensure_user, users
from profile import sanitize_name, sanitize_age, profile_text, append_history, end_session, start_history
from moderation import is_muted, apply_respect, review_history_and_penalize
from matchmaking import add_to_wait, try_match, start_timeout_watcher, remove_from_wait
from messages import (WELCOME, HELP, SEARCHING, INTRO_PARTNER, NO_MATCH,
                      LEAVE_CONFIRM, LEAVE_TOO_SOON, LEFT_YOU, LEFT_PARTNER,
                      REPORT_CONFIRM, REPORT_OK, REPORT_RESULT, MUTED, BANNED, delayed_send)

if not TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN Ù…ÙÙ‚ÙˆØ¯. Ø£Ø¶ÙÙ‡ ÙÙŠ Render â†’ Environment.")

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")

# ============ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ============
def main_menu(in_chat: bool = False) -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¤ Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"), KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"))
    if in_chat:
        kb.add(KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"), KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    kb.add(KeyboardButton("ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©"))
    return kb

def topics_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for i in range(0, len(TOPICS), 2):
        row = [KeyboardButton(TOPICS[i])]
        if i + 1 < len(TOPICS):
            row.append(KeyboardButton(TOPICS[i+1]))
        kb.add(*row)
    return kb

def target_gender_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¨ Ø±Ø¬Ù„"), KeyboardButton("ğŸ‘© Ø§Ù…Ø±Ø£Ø©"))
    kb.add(KeyboardButton("Ø£ÙŠ"))
    return kb

def yes_no_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("Ù†Ø¹Ù… âœ…"), KeyboardButton("Ù„Ø§ âŒ"))
    return kb

# ============ Ø­Ø§Ù„Ø§Øª ============
@bot.message_handler(commands=["start"])
def cmd_start(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        delayed_send(bot, uid, BANNED, delay=0.4)
        return

    if u.get("gender") is None:
        u["state"] = "AWAIT_GENDER"
        save_users()
        delayed_send(bot, uid, WELCOME, delay=0.4, reply_markup=ReplyKeyboardRemove())
        kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        kb.add(KeyboardButton("Ø°ÙƒØ±"), KeyboardButton("Ø£Ù†Ø«Ù‰"), KeyboardButton("Ø£Ø®Ø±Ù‰"))
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·):", delay=0.8, reply_markup=kb)
        return

    u["state"] = None
    save_users()
    delayed_send(bot, uid, "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯! Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", delay=0.4, reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["help"])
def cmd_help(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return
    delayed_send(bot, uid, HELP, delay=0.2, reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["profile"])
def cmd_profile(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    delayed_send(bot, uid, profile_text(users[uid]), delay=0.2, reply_markup=main_menu(in_chat=bool(users[uid].get("partner"))))

# ============ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ù… ============
@bot.message_handler(func=lambda msg: True, content_types=["text"])
def on_text(m: Message):
    uid = m.from_user.id
    txt = (m.text or "").strip()
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return

    state = u.get("state")

    # â€”â€” Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ â€”â€”
    if state == "AWAIT_GENDER":
        if txt not in GENDERS:
            kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
            kb.add(KeyboardButton("Ø°ÙƒØ±"), KeyboardButton("Ø£Ù†Ø«Ù‰"), KeyboardButton("Ø£Ø®Ø±Ù‰"))
            delayed_send(bot, uid, "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±: Ø°ÙƒØ± / Ø£Ù†Ø«Ù‰ / Ø£Ø®Ø±Ù‰", delay=0.3, reply_markup=kb)
            return
        u["gender"] = txt
        u["state"] = "AWAIT_NAME"
        save_users()
        delayed_send(bot, uid, "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ (Ù¢â€“Ù£Ù  Ø­Ø±ÙÙ‹Ø§ØŒ Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…):", delay=0.3, reply_markup=ReplyKeyboardRemove())
        return

    if state == "AWAIT_NAME":
        name = sanitize_name(txt)
        if not name:
            delayed_send(bot, uid, "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§:", delay=0.3)
            return
        u["name"] = name
        u["state"] = "AWAIT_AGE"
        save_users()
        delayed_send(bot, uid, "Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ (10â€“120):", delay=0.3)
        return

    if state == "AWAIT_AGE":
        age = sanitize_age(txt)
        if age is None:
            delayed_send(bot, uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:", delay=0.3)
            return
        u["age"] = age
        u["state"] = None
        save_users()
        delayed_send(bot, uid, "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸.\n" + profile_text(u), delay=0.4, reply_markup=main_menu(in_chat=False))
        delayed_send(bot, uid, "Ø§Ø¶ØºØ·: ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù†Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØªÙƒ.", delay=0.5)
        return

    # â€”â€” Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€”â€” 
    if txt == "ğŸ‘¤ Ù…Ù„ÙÙŠ":
        delayed_send(bot, uid, profile_text(u), delay=0.2, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        u["state"] = "EDIT_NAME"
        save_users()
        delayed_send(bot, uid, "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", delay=0.2, reply_markup=ReplyKeyboardRemove())
        return

    if state == "EDIT_NAME":
        name = sanitize_name(txt)
        if not name:
            delayed_send(bot, uid, "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§:", delay=0.2)
            return
        u["name"] = name
        u["state"] = None
        save_users()
        delayed_send(bot, uid, "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.\n" + profile_text(u), delay=0.3, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        u["state"] = "EDIT_AGE"
        save_users()
        delayed_send(bot, uid, "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (10â€“120):", delay=0.2, reply_markup=ReplyKeyboardRemove())
        return

    if state == "EDIT_AGE":
        age = sanitize_age(txt)
        if age is None:
            delayed_send(bot, uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:", delay=0.2)
            return
        u["age"] = age
        u["state"] = None
        save_users()
        delayed_send(bot, uid, "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.\n" + profile_text(u), delay=0.3, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©":
        delayed_send(bot, uid, HELP, delay=0.2, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©":
        # ØªØ­Ù‚Ù‚ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù
        if not (u.get("gender") and u.get("name") and u.get("age")):
            delayed_send(bot, uid, "âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ø¹Ø¨Ø± /start.", delay=0.3)
            return
        u["state"] = "CHOOSE_TOPIC"
        save_users()
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø´:", delay=0.2, reply_markup=topics_menu())
        return

    if state == "CHOOSE_TOPIC":
        if txt not in TOPICS:
            delayed_send(bot, uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±:", delay=0.2, reply_markup=topics_menu())
            return
        u["topic"] = txt
        u["state"] = "CHOOSE_TARGET_GENDER"
        save_users()
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹Ù‡:", delay=0.2, reply_markup=target_gender_menu())
        return

    if state == "CHOOSE_TARGET_GENDER":
        if txt not in TARGET_GENDERS:
            delayed_send(bot, uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±:", delay=0.2, reply_markup=target_gender_menu())
            return
        u["search_pref"] = "Ø£ÙŠ" if txt == "Ø£ÙŠ" else txt
        u["state"] = None
        save_users()
        # Ø£Ø¶ÙÙ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙˆØ±Ù‹Ø§
        add_to_wait(u["topic"], uid, u["search_pref"])
        delayed_send(bot, uid, SEARCHING, delay=0.5, reply_markup=main_menu(in_chat=False))
        # Ø¬Ø±Ù‘Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙˆØ±ÙŠØ©
        partner_id = try_match(uid, u["topic"])
        if partner_id:
            start_chat(uid, partner_id)
        return

    # â€”â€” Ø¯Ø§Ø®Ù„ Ù…Ø­Ø§Ø¯Ø«Ø© â€”â€” 
    if u.get("partner"):
        # Ø­Ø¸Ø± Ø¬Ø²Ø¦ÙŠØŸ
        muted, left = is_muted(u)
        if muted:
            delayed_send(bot, uid, MUTED.format(left=left), delay=0.2)
            return

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        if txt == "ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©":
            # Ù„Ø§ ØªÙÙ…Ø±Ø± Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± â€” ÙÙ‚Ø· ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯Ùƒ
            started = u.get("chat_started_at") or 0
            elapsed = time.time() - started
            if elapsed < LEAVE_DELAY:
                delayed_send(bot, uid, LEAVE_TOO_SOON.format(remain=int(LEAVE_DELAY - elapsed)), delay=0.2)
                return
            u["state"] = "CONFIRM_LEAVE"
            save_users()
            delayed_send(bot, uid, LEAVE_CONFIRM, delay=0.2, reply_markup=yes_no_menu())
            return

        if u.get("state") == "CONFIRM_LEAVE":
            if txt == "Ù†Ø¹Ù… âœ…":
                # Ø£Ù†Ù‡Ù Ø§Ù„Ø¬Ù„Ø³Ø©
                pid = u.get("partner")
                p = users.get(pid)
                end_session(u, p)
                delayed_send(bot, uid, LEFT_YOU, delay=0.2, reply_markup=main_menu(in_chat=False))
                # Ø£Ø¨Ù„Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙ‚Ø· Ø¨Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ø¨Ø¯ÙˆÙ† ØªÙØ§ØµÙŠÙ„ Ø£Ø²Ø±Ø§Ø±)
                if pid:
                    try:
                        delayed_send(bot, pid, LEFT_PARTNER, delay=0.2, reply_markup=main_menu(in_chat=False))
                    except Exception as e:
                        print(f"[LEAVE NOTIFY PARTNER] {e}")
                u["state"] = None
                save_users()
                return
            elif txt == "Ù„Ø§ âŒ":
                u["state"] = None
                save_users()
                delayed_send(bot, uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. ØªØ§Ø¨Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ‘Œ", delay=0.2)
                return
            else:
                delayed_send(bot, uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", delay=0.2, reply_markup=yes_no_menu())
                return

        if txt == "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº":
            # ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¨Ù„Ù‘Øº ÙÙ‚Ø·
            u["state"] = "CONFIRM_REPORT"
            save_users()
            delayed_send(bot, uid, REPORT_CONFIRM, delay=0.2, reply_markup=yes_no_menu())
            return

        if u.get("state") == "CONFIRM_REPORT":
            if txt == "Ù†Ø¹Ù… âœ…":
                pid = u.get("partner")
                p = users.get(pid)
                hist = (u.get("history") or [])[-50:]
                you_line, other_line = review_history_and_penalize(uid, pid, hist)
                delayed_send(bot, uid, REPORT_OK, delay=0.2)
                delayed_send(bot, uid, REPORT_RESULT.format(
                    lines=f"â€¢ {you_line}\nâ€¢ {other_line}",
                    respect=users[uid].get("respect", 80)
                ), delay=0.3)
                # Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                if ADMIN_CHAT_ID:
                    try:
                        bot.send_message(int(ADMIN_CHAT_ID), f"ğŸš¨ Ø¨Ù„Ø§Øº Ù…Ù† {uid} Ø¶Ø¯ {pid}\n{you_line}\n{other_line}")
                    except Exception as e:
                        print(f"[ADMIN REPORT] {e}")
                u["state"] = None
                save_users()
                return
            elif txt == "Ù„Ø§ âŒ":
                u["state"] = None
                save_users()
                delayed_send(bot, uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. ØªØ§Ø¨Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ‘Œ", delay=0.2)
                return
            else:
                delayed_send(bot, uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", delay=0.2, reply_markup=yes_no_menu())
                return

        # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù„Ø§ ØªÙØ¸Ù‡Ø± Ø§Ù„Ø§Ø³Ù… â€” ÙÙ‚Ø· ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù†Øµ)
        warn = apply_respect(uid, txt)
        if warn:
            delayed_send(bot, uid, warn, delay=0.1)
            # ÙÙŠ Ø­Ø§Ù„ ØµØ§Ø± Ø­Ø¸Ø± ÙƒØ§Ù…Ù„ØŒ Ø£Ù†Ù‡Ù Ø§Ù„Ø¬Ù„Ø³Ø©
            if users[uid].get("banned_full"):
                pid = u.get("partner")
                p = users.get(pid)
                end_session(u, p)
                try:
                    delayed_send(bot, pid, "âš ï¸ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø³Ø¨Ø¨ Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±.", delay=0.2, reply_markup=main_menu(in_chat=False))
                except Exception as e:
                    print(f"[BAN NOTIFY] {e}")
                return

        # Ù…Ø±Ù‘Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙ‚Ø· ÙƒÙ†Øµ
        pid = u.get("partner")
        p = users.get(pid)
        if not p:
            # Ø´Ø±ÙŠÙƒ Ù…ÙÙ‚ÙˆØ¯ â€” Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            end_session(u, None)
            delayed_send(bot, uid, LEFT_PARTNER, delay=0.2, reply_markup=main_menu(in_chat=False))
            return

        append_history(u, p, uid, txt)
        try:
            bot.send_message(pid, txt)
        except Exception as e:
            print(f"[RELAY] {e}")
        return

    # â€”â€” Ø®Ø§Ø±Ø¬ Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ£ÙˆØ§Ù…Ø± ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…Ø© â€”â€” 
    delayed_send(bot, uid, "â” Ù„Ù… Ø£ÙÙ‡Ù…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„.", delay=0.2, reply_markup=main_menu(in_chat=False))

# ============ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©/Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§ ============
def start_chat(u1_id: int, u2_id: int):
    u1 = users[u1_id]; u2 = users[u2_id]
    u1["partner"] = u2_id
    u2["partner"] = u1_id
    start_history(u1)  # resets history & sets chat_started_at
    start_history(u2)
    # Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    remove_from_wait(u1_id)
    remove_from_wait(u2_id)
    save_users()
    # Ø±Ø³Ø§Ù„Ø© ØªØ¹Ø±ÙŠÙ Ø®ÙÙŠÙØ© (Ø¨Ø¯ÙˆÙ† Ø£Ø³Ù…Ø§Ø¡ Ø¶Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„Ø§Ø­Ù‚Ø©)
    try:
        delayed_send(bot, u1_id, INTRO_PARTNER, delay=0.5, reply_markup=main_menu(in_chat=True))
        delayed_send(bot, u2_id, INTRO_PARTNER, delay=0.6, reply_markup=main_menu(in_chat=True))
    except Exception as e:
        print(f"[INTRO] {e}")

# ============ Ø§Ù„ØªØ´ØºÙŠÙ„ ============
def main():
    print("[BOOT] Loading users...")
    load_users()
    print(f"[BOOT] Users: {len(users)}")
    try:
        bot.remove_webhook()
    except Exception as e:
        print(f"[WEBHOOK] {e}")
    start_timeout_watcher(bot)
    print("[RUN] pollingâ€¦")
    bot.infinity_polling(skip_pending=True, timeout=20)

if __name__ == "__main__":
    main()
