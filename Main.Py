# Main.py
import os
import time
import traceback
import telebot
from flask import Flask, request
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, Message

# ---------- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© ----------
import config  # ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ TOKEN, WEBHOOK_URL, WEBHOOK_PATH, PORT, LEAVE_DELAY, TOPICS, GENDERS, TARGET_GENDERS
from storage import load_users, save_users, users, ensure_user
from Profile_manger import (
    sanitize_name,
    sanitize_age,
    profile_text,
    append_history,
    end_session,
    start_history,
)
from Moderation import is_muted, apply_respect, review_history_and_penalize
from Matchmaking import add_to_wait, try_match, start_timeout_watcher, remove_from_wait
from messages import (
    delayed_send,
    get_welcome_message,
    WELCOME,
    HELP,
    SEARCHING,
    NO_MATCH,
    INTRO_PARTNER,
    LEAVE_CONFIRM,
    LEAVE_TOO_SOON,
    LEFT_YOU,
    LEFT_PARTNER,
    REPORT_CONFIRM,
    REPORT_OK,
    REPORT_RESULT,
    MUTED,
    BANNED,
)
# Bad_word helper (Ø¥Ù† ÙˆÙØ¬Ø¯) Ù„ØªØµÙÙŠØ© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³ÙŠØ¦Ø© â€” Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¯ÙˆØ§Ù„ Ù…Ù…Ø§Ø«Ù„Ø©
try:
    from Bad_word import contains_bad_word, censor_text
except Exception:
    # Ù†ÙØ¹Ø±Ù‘Ù Ù†ÙˆØ§ØªØ¬ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„Ø§Ø³Ù… Ø°Ø§ØªÙ‡
    def contains_bad_word(text):
        return False

    def censor_text(text):
        return text

# ---------- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª ÙˆÙÙ„ÙØ³Ù’Ùƒ ----------
TOKEN = getattr(config, "TOKEN", None)
if not TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN Ù…ÙÙ‚ÙˆØ¯. Ø¶Ø¹Ù‡ ÙÙŠ config.TOKEN")

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")
app = Flask(__name__)

# ---------- Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù‚Ø§Ø¦Ù…Ø© Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙƒÙŠØ¨ÙˆØ±Ø¯Ø§Øª ----------
def main_menu(in_chat: bool = False) -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¤ Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"), KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"))
    if in_chat:
        kb.add(KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"), KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    kb.add(KeyboardButton("ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©"))
    return kb

def topics_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for i in range(0, len(config.TOPICS), 2):
        row = [KeyboardButton(config.TOPICS[i])]
        if i + 1 < len(config.TOPICS):
            row.append(KeyboardButton(config.TOPICS[i+1]))
        kb.add(*row)
    return kb

def target_gender_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¨ Ø±Ø¬Ù„"), KeyboardButton("ğŸ‘© Ø§Ù…Ø±Ø£Ø©"))
    kb.add(KeyboardButton("Ø£ÙŠ"))
    return kb

def yes_no_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("Ù†Ø¹Ù… âœ…"), KeyboardButton("Ù„Ø§ âŒ"))
    return kb

# ---------- ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ù…Ù† + ØªØ­Ù…ÙŠÙ„ Ø³Ø§Ø¨Ù‚ ----------
def update_user(uid, updates: dict):
    ensure_user(uid)
    users[uid].update(updates)
    try:
        save_users()
    except Exception as e:
        print(f"[SAVE USER ERROR] {e}")

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹
load_users()

# ---------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø§Øª ----------
def safe_delayed_send(uid, text, delay=0.4, **kwargs):
    try:
        delayed_send(bot, uid, text, delay=delay, **kwargs)
    except Exception as e:
        print(f"[DELAYED_SEND ERROR] {e}, text: {text}")

# ---------- /start ----------
@bot.message_handler(commands=["start"])
def cmd_start(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]

    if u.get("banned_full"):
        delayed_send(bot, uid, BANNED, delay=0.4)
        return

    # ---- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† START_MESSAGES ----
    welcome_text = get_welcome_message(topic="START")
    delayed_send(bot, uid, welcome_text, delay=0.4, reply_markup=ReplyKeyboardRemove())

    # ---- Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù… ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø¬Ù†Ø³ ----
    if not u.get("gender"):
        u["state"] = "AWAIT_GENDER"
        save_users()
        kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        kb.add(*[KeyboardButton(g) for g in config.GENDERS])
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ø¬Ù†Ø³Ù‹Ø§ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·):", delay=0.8, reply_markup=kb)
        return

    # ---- Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¦Ø¯ ----
    u["state"] = None
    save_users()
    delayed_send(
        bot,
        uid,
        "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯! Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:",
        delay=0.4,
        reply_markup=main_menu(in_chat=bool(u.get("partner")))
    )

# ---------- /help ----------
@bot.message_handler(commands=["help"])
def cmd_help(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    if users[uid].get("banned_full"):
        return
    safe_delayed_send(uid, HELP, delay=0.2, reply_markup=main_menu(in_chat=bool(users[uid].get("partner"))))


# ---------- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØµÙŠØ© Ø¹Ø§Ù…Ø© (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±) ----------
@bot.message_handler(func=lambda msg: True, content_types=["text"])
def on_text(m: Message):
    uid = m.from_user.id
    txt = (m.text or "").strip()
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return

    # Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    state = u.get("state") or ""

    # Ø­Ø§Ù„Ø§Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù†Ø§Ø¡Ø©
    if state == "AWAIT_GENDER":
        handle_gender(uid, txt); return
    if state == "AWAIT_NAME":
        handle_edit_name(uid, txt); return
    if state == "AWAIT_AGE":
        handle_edit_age(uid, txt); return
    if state == "CHOOSE_TOPIC":
        handle_topic_selection(uid, txt); return
    if state == "CHOOSE_TARGET_GENDER":
        handle_target_gender(uid, txt); return
    if state == "CONFIRM_LEAVE":
        handle_leave_confirm(uid, u, txt); return
    if state == "CONFIRM_REPORT":
        handle_report_confirm(uid, u, txt); return

    # Ø£ÙˆØ§Ù…Ø± Ø£Ø²Ø±Ø§Ø± Ø«Ø§Ø¨ØªØ©
    if txt == "ğŸ‘¤ Ù…Ù„ÙÙŠ":
        safe_delayed_send(uid, profile_text(u), delay=0.2, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        update_user(uid, {"state": "AWAIT_NAME"})
        safe_delayed_send(uid, "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", delay=0.2, reply_markup=ReplyKeyboardRemove())
        return

    if txt == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        update_user(uid, {"state": "AWAIT_AGE"})
        safe_delayed_send(uid, "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (10â€“120):", delay=0.2, reply_markup=ReplyKeyboardRemove())
        return

    if txt == "ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©":
        safe_delayed_send(uid, HELP, delay=0.2, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©":
        handle_search_request(uid); return

    # Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø´Ø±ÙŠÙƒØŒ ØªÙÙ…Ø±Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡ (Ø¨Ø¹Ø¯ ÙÙ„Ø§ØªØ± ÙˆÙ…Ø±Ø´Ø­Ø§Øª)
    if u.get("partner"):
        handle_chat_message(uid, txt, u); return

    # Default
    safe_delayed_send(uid, "â” Ù„Ù… Ø£ÙÙ‡Ù…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„.", delay=0.2, reply_markup=main_menu(in_chat=False))


# ---------- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¬Ù†Ø³ ----------
def handle_gender(uid, txt):
    txt = txt.strip()
    if txt not in getattr(config, "GENDERS", ["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰", "Ø£Ø®Ø±Ù‰"]):
        safe_delayed_send(uid, "Ø§Ø®ØªØ±: Ø°ÙƒØ± / Ø£Ù†Ø«Ù‰ / Ø£Ø®Ø±Ù‰", delay=0.2)
        return
    update_user(uid, {"gender": txt, "state": None})
    safe_delayed_send(uid, "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù†Ø³ âœ…", delay=0.2, reply_markup=main_menu(in_chat=False))


# ---------- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… ----------
def handle_edit_name(uid, txt):
    name = sanitize_name(txt)
    update_user(uid, {"name": name, "state": None})
    safe_delayed_send(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰: {name}", delay=0.2, reply_markup=main_menu(in_chat=False))


# ---------- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø± ----------
def handle_edit_age(uid, txt):
    age = sanitize_age(txt)
    if not age:
        safe_delayed_send(uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120.", delay=0.2, reply_markup=ReplyKeyboardRemove())
        return
    update_user(uid, {"age": age, "state": None})
    safe_delayed_send(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ø± Ø¥Ù„Ù‰: {age}", delay=0.2, reply_markup=main_menu(in_chat=False))


# ---------- Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø© (Ù…ÙˆØ¶ÙˆØ¹ + Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù) ----------
def handle_search_request(uid):
    ensure_user(uid)
    u = users[uid]
    if u.get("partner"):
        safe_delayed_send(uid, "âš ï¸ Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø©!", delay=0.2)
        return

    update_user(uid, {"state": "CHOOSE_TOPIC"})
    kb = topics_menu()
    safe_delayed_send(uid, "Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø´:", delay=0.2, reply_markup=kb)


# ---------- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø«Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±Ø¬Øª Ø¬Ù†Ø¯Ø± Ø«Ù… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« ----------
def handle_topic_selection(uid, txt):
    txt = txt.strip()
    if txt not in config.TOPICS:
        safe_delayed_send(uid, "âŒ Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", delay=0.2, reply_markup=topics_menu())
        return

    update_user(uid, {"topic": txt, "state": "CHOOSE_TARGET_GENDER"})
    safe_delayed_send(uid, f"ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: {txt}\nØ§Ù„Ø¢Ù† Ø§Ø®ØªØ± Ø¬Ù†Ø³ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡:", delay=0.2, reply_markup=target_gender_menu())


def handle_target_gender(uid, txt):
    txt = txt.strip()
    valid = ["ğŸ‘¨ Ø±Ø¬Ù„", "ğŸ‘© Ø§Ù…Ø±Ø£Ø©", "Ø£ÙŠ"]
    if txt not in valid:
        safe_delayed_send(uid, "âŒ Ø§Ø®ØªØ±: ğŸ‘¨ Ø±Ø¬Ù„ / ğŸ‘© Ø§Ù…Ø±Ø£Ø© / Ø£ÙŠ", delay=0.2, reply_markup=target_gender_menu())
        return

    # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¨Ø­Ø«
    # Ù†Ø­ÙˆÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø¥Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    target = None
    if txt == "ğŸ‘¨ Ø±Ø¬Ù„":
        target = "male"
    elif txt == "ğŸ‘© Ø§Ù…Ø±Ø£Ø©":
        target = "female"
    else:
        target = "any"

    u = users[uid]
    topic = u.get("topic")
    update_user(uid, {"target_gender": target, "state": "SEARCHING"})
    # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø®Ø§ØµØ© Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
    safe_delayed_send(uid, get_welcome_message(topic), delay=0.4)
    safe_delayed_send(uid, SEARCHING, delay=0.4, reply_markup=main_menu(in_chat=False))

    # Ø£Ø¶Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø­Ø³Ø¨ Matchmaking
    try:
        add_to_wait(uid, topic, target)
    except TypeError:
        # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙˆØ§Ø¬Ù‡Ø© add_to_wait Ù‚Ø¯ ØªØ®ØªÙ„ÙØŒ Ù†Ø¹Ù…Ù„ Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·:
        try:
            add_to_wait(uid, topic)
        except Exception as e:
            print(f"[add_to_wait ERROR] {e}")

    # Ø¬Ø±Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    try:
        try_match(bot, uid, topic, target)
    except TypeError:
        try:
            try_match(bot, uid, topic)
        except Exception as e:
            print(f"[try_match ERROR] {e}")

    # Ø´ØºÙ‘Ù„ ÙˆÙˆØªØ´Ø± Ù„Ù„ØªØ§ÙŠÙ… Ø¢ÙˆØª Ù„Ùˆ ÙƒØ§Ù† Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© ÙÙŠ Matchmaking
    try:
        start_timeout_watcher(bot, uid, topic)
    except TypeError:
        try:
            start_timeout_watcher(bot)
        except Exception as e:
            print(f"[start_timeout_watcher ERROR] {e}")


# ---------- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ØªØ£ÙƒÙŠØ¯ ÙˆÙ…ØºØ§Ø¯Ø±Ø©) ----------
def handle_leave_request(uid):
    ensure_user(uid)
    u = users[uid]
    started = u.get("chat_started_at") or 0
    elapsed = time.time() - started
    if elapsed < getattr(config, "LEAVE_DELAY", 30):
        safe_delayed_send(uid, LEAVE_TOO_SOON.format(remain=int(getattr(config, "LEAVE_DELAY", 30) - elapsed)), delay=0.2)
        return
    update_user(uid, {"state": "CONFIRM_LEAVE"})
    safe_delayed_send(uid, LEAVE_CONFIRM, delay=0.2, reply_markup=yes_no_menu())


def handle_leave_confirm(uid, u, txt):
    if txt == "Ù†Ø¹Ù… âœ…":
        pid = u.get("partner")
        if pid:
            # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„ÙƒÙ„ÙŠÙ‡Ù…Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Profile_manger.end_session Ø£Ùˆ Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ø¯Ù„Ø©
            try:
                end_session(u, users.get(pid))
            except Exception:
                # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ end_session Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØ²Ø± ids
                try:
                    end_session(uid)
                    end_session(pid)
                except Exception as e:
                    print(f"[END_SESSION ERROR] {e}")
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§
            update_user(uid, {"partner": None, "state": None})
            update_user(pid, {"partner": None, "state": None})
            safe_delayed_send(uid, "Ù„Ù‚Ø¯ ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", delay=0.2, reply_markup=main_menu(in_chat=False))
            try:
                safe_delayed_send(pid, "Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", delay=0.2, reply_markup=main_menu(in_chat=False))
            except Exception:
                pass
        else:
            update_user(uid, {"state": None})
            safe_delayed_send(uid, "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠ.", delay=0.2)
    elif txt == "Ù„Ø§ âŒ":
        update_user(uid, {"state": None})
        safe_delayed_send(uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. ØªØ§Ø¨Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ‘Œ", delay=0.2)
    else:
        safe_delayed_send(uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", delay=0.2, reply_markup=yes_no_menu())


# ---------- Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø´Ø±ÙŠÙƒ (ØªØ£ÙƒÙŠØ¯ Ø«Ù… Ù…Ø±Ø§Ø¬Ø¹Ø©) ----------
def handle_report_request(uid):
    ensure_user(uid)
    u = users[uid]
    if not u.get("partner"):
        safe_delayed_send(uid, "âŒ Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†.", delay=0.2)
        return
    update_user(uid, {"state": "CONFIRM_REPORT"})
    safe_delayed_send(uid, REPORT_CONFIRM, delay=0.2, reply_markup=yes_no_menu())


def handle_report_confirm(uid, u, txt):
    if txt == "Ù†Ø¹Ù… âœ…":
        pid = u.get("partner")
        # Ø§Ø·Ù„Ø¨ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¯Ø±ÙŠØ´Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        try:
            result = review_history_and_penalize(uid, pid)  # Ù…Ù† Moderation.py
        except Exception as e:
            print(f"[review_history_and_penalize ERROR] {e}")
            result = None
        update_user(uid, {"state": None})
        safe_delayed_send(uid, REPORT_OK, delay=0.2)
        if result:
            # Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ© Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹ÙŠØ¯ Ø´ÙŠØ¦Ù‹Ø§
            try:
                safe_delayed_send(uid, REPORT_RESULT.format(lines=result.get("lines", "â€”"), respect=result.get("respect", "â€”")), delay=0.4)
            except Exception:
                pass
    elif txt == "Ù„Ø§ âŒ":
        update_user(uid, {"state": None})
        safe_delayed_send(uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒ.", delay=0.2)
    else:
        safe_delayed_send(uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", delay=0.2, reply_markup=yes_no_menu())


# ---------- ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ Ù…Ø¹ ÙÙ„ØªØ±Ø© ÙˆÙ…ÙˆØ¯Ø±ÙŠØ´Ù† Ø¨Ø³ÙŠØ·Ø© ----------
def handle_chat_message(uid, txt, u):
    # ØªØ­Ù‚Ù‚ Ø¥Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªÙ‹Ø§
    if is_muted(uid):
        # is_muted ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙØ±Ø¬Ø¹ ÙˆÙ‚Øª Ù…ØªØ¨Ù‚ÙŠ Ø£Ùˆ boolean â€” Ù†Ø­Ù† Ù†Ø¯Ø¹Ù… boolean Ù‡Ù†Ø§
        safe_delayed_send(uid, MUTED.format(left=60), delay=0.2)
        return

    # ÙÙ„ØªØ±Ø© ÙƒÙ„Ù…Ø§Øª Ø³ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
    try:
        if contains_bad_word(txt):
            censored = censor_text(txt)
            safe_delayed_send(uid, "âš ï¸ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ø§Ø­ØªÙˆØ§Ø¦Ù‡Ø§ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©.", delay=0.2)
            txt_to_send = censored
        else:
            txt_to_send = txt
    except Exception:
        txt_to_send = txt

    # ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… (Ø²ÙŠØ§Ø¯Ø©/Ù†Ù‚ØµØ§Ù† Ù†Ù‚Ø§Ø· Ù…Ø«Ù„Ø§Ù‹)
    try:
        apply_respect(uid, txt_to_send)
    except Exception:
        pass

    # Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ (Profile_manger.append_history)
    try:
        append_history(uid, txt_to_send)
    except Exception:
        pass

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø´Ø±ÙŠÙƒ
    pid = u.get("partner")
    if not pid or pid not in users:
        update_user(uid, {"partner": None})
        safe_delayed_send(uid, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠ â€” Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", delay=0.2, reply_markup=main_menu(in_chat=False))
        return

    try:
        bot.send_message(pid, f"ğŸ’¬ {txt_to_send}")
    except Exception as e:
        print(f"[SEND TO PARTNER ERROR] {e}")
        # Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¹Ù„Ù… Ø§Ù„Ù…Ø±Ø³Ù„
        safe_delayed_send(uid, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠÙƒ.", delay=0.2)


# ---------- Webhook: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Telegram Ø¹Ø¨Ø± Flask ----------
@app.route(f"/{getattr(config, 'WEBHOOK_PATH', 'webhook')}", methods=["POST"])
def webhook():
    try:
        json_str = request.get_data().decode("utf-8")
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        print(f"[WEBHOOK PROCESS ERROR] {e}\n{traceback.format_exc()}")
    return "", 200

def set_webhook():
    url = os.environ.get("WEBHOOK_URL") or getattr(config, "WEBHOOK_URL", None)
    path = getattr(config, "WEBHOOK_PATH", "webhook")
    if not url:
        raise RuntimeError("WEBHOOK_URL Ù…ÙÙ‚ÙˆØ¯. Ø¶Ø¹Ù‡ ÙÙŠ Environment Ø£Ùˆ config.WEBHOOK_URL")
    bot.remove_webhook()
    bot.set_webhook(f"{url}/{path}")
    print(f"[WEBHOOK] Set to {url}/{path}")


# ---------- ØªÙ‡ÙŠØ¦Ø© Matchmaking watcher Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ----------
try:
    # Ø¥Ø°Ø§ Matchmaking.start_timeout_watcher ØªØªØ·Ù„Ø¨ bot ÙÙ‚Ø·
    start_timeout_watcher(bot)
except Exception:
    try:
        start_timeout_watcher()
    except Exception:
        pass

# ---------- Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ----------
if __name__ == "__main__":
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¨Ù‚Ù‹Ø§
    try:
        load_users()
    except Exception as e:
        print(f"[LOAD_USERS ERROR] {e}")
    # Ø¥Ø¹Ø¯Ø§Ø¯ webhook Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    try:
        set_webhook()
    except Exception as e:
        print(f"[WEBHOOK ERROR] {e}")

    # ØªØ´ØºÙŠÙ„ Flask app (Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… webhook)
    port = int(os.environ.get("PORT", getattr(config, "PORT", 5000)))
    print(f"[RUN] Webhook listening on port {port}â€¦")
    app.run(host="0.0.0.0", port=port) 
