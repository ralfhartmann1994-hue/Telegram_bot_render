# Main.py
# Ù…Ù„Ù Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: ØªÙƒØ§Ù…Ù„ Ù…Ø¹ profile.py, storage.py, Matchmaking.py, Moderation.py, messages.py, Bad_word.py
# ÙŠÙˆÙÙ‘Ø± ØªØ³Ù„Ø³Ù„Ø§Ù‹ ÙˆØ§Ø¶Ø­Ø§Ù‹: /start -> (Ø§Ø³Ù… -> Ø¬Ù†Ø³ -> Ø¹Ù…Ø±) -> Ù‚Ø§Ø¦Ù…Ø© Ø±Ø¦ÙŠØ³ÙŠØ© -> Ø§Ù„Ø¨Ø­Ø« / Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
# ØªØ§Ø±ÙŠØ®: 2025

import os
import time
import traceback
from typing import Optional

from flask import Flask, request
import telebot
from telebot.types import (
    ReplyKeyboardMarkup,
    KeyboardButton,
    ReplyKeyboardRemove,
    Message,
)

# ---------- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ----------
# Ù…Ù„Ù Ø§Ù„ØªØ®Ø²ÙŠÙ† (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ dict usersØŒ ÙˆØ¯ÙˆØ§Ù„ load_users/save_users/ensure_user Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
import storage
from storage import users, load_users, save_users, ensure_user as storage_ensure_user

# Ù…Ù„Ù Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙÙ‡Ø§)
import Profile_manger as ProfileManager
from Profile_manger import (
    ensure_user,
    set_user_name,
    set_user_age,
    set_user_gender,
    profile_text,
    start_history,
    append_history,
    end_session,
)

# Matchmaking (Ø§Ù†ØªØ¸Ø§Ø± ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª)
try:
    from Matchmaking import add_to_wait, try_match, start_timeout_watcher, remove_from_wait
except Exception:
    # ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© / Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ
    def add_to_wait(*args, **kwargs):
        raise RuntimeError("Matchmaking.add_to_wait ØºÙŠØ± Ù…ØªØ§Ø­")
    def try_match(*args, **kwargs):
        return None
    def start_timeout_watcher(bot=None):
        return
    def remove_from_wait(*args, **kwargs):
        return

# Moderation (ÙÙ„Ø§ØªØ± ÙƒÙ„Ù…Ø§ØªØŒ Ù…ÙŠÙˆØªØŒ Ø§Ø­ØªØ±Ø§Ù…)
try:
    from Moderation import is_muted, apply_respect, review_history_and_penalize, check_message_safe
except Exception:
    def is_muted(uid): return False
    def apply_respect(uid, text): return
    def review_history_and_penalize(uid, pid, history): return None
    def check_message_safe(text): return True

# Ø±Ø³Ø§Ø¦Ù„ØŒ Ù†ØµÙˆØµØŒ delayed_send
try:
    from messages import delayed_send, get_welcome_message, WELCOME, HELP, SEARCHING, NO_MATCH, INTRO_PARTNER, LEAVE_CONFIRM, LEAVE_TOO_SOON, LEFT_YOU, LEFT_PARTNER, REPORT_CONFIRM, REPORT_OK, REPORT_RESULT, MUTED, BANNED
except Exception:
    # ØªÙ‚Ø¯ÙŠÙ… Ø¨Ø¯Ø§Ø¦Ù„ Ø¨Ø³ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù messages
    def delayed_send(bot_obj, chat_id, text, **kwargs):
        try:
            bot_obj.send_message(chat_id, text, **kwargs)
        except Exception:
            print("[delayed_send fallback] failed to send")
    def get_welcome_message(topic_key="START"):
        return "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ."
    WELCOME = "Ù…Ø±Ø­Ø¨Ø§Ù‹!"
    HELP = "Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø±."
    SEARCHING = "ğŸ” Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«..."
    NO_MATCH = "Ù„Ù… Ù†Ø¬Ø¯ Ø´Ø±ÙŠÙƒÙ‹Ø§ Ø§Ù„Ø¢Ù†."
    INTRO_PARTNER = "Ù„Ù‚Ø¯ ØªÙ…Ù‘ Ø±Ø¨Ø·Ùƒ Ø¨Ø´Ø±ÙŠÙƒ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©!"
    LEAVE_CONFIRM = "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ"
    LEAVE_TOO_SOON = "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¢Ù†. Ø§Ù†ØªØ¸Ø± {remain} Ø«Ø§Ù†ÙŠØ©."
    LEFT_YOU = "Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©."
    LEFT_PARTNER = "Ù„Ù‚Ø¯ ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©."
    REPORT_CONFIRM = "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØŸ"
    REPORT_OK = "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº."
    REPORT_RESULT = "Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº: {lines} Ø£Ø³Ø·Ø±."
    MUTED = "Ù…Ø­Ø¸ÙˆØ± Ù…Ø¤Ù‚ØªÙ‹Ø§. ØªØ¨Ù‚Ù‰ {left} Ø«Ø§Ù†ÙŠØ©."
    BANNED = "Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…."

# Bad_word (Ø¥Ù† ÙˆÙØ¬Ø¯)
try:
    from Bad_word import contains_bad_word, censor_text
except Exception:
    def contains_bad_word(text):
        return False
    def censor_text(text):
        return text

# ---------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ----------
TOKEN = os.environ.get("TELEGRAM_TOKEN") or getattr(__import__("config"), "TOKEN", None) if os.path.exists("config.py") else None
if not TOKEN:
    # Ø­Ø§ÙˆÙ„ TELEGRAM_TOKEN ÙƒØ®ÙŠØ§Ø± Ø¨Ø¯ÙŠÙ„
    TOKEN = os.environ.get("BOT_TOKEN") or os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN Ø£Ùˆ BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ environment Ø£Ùˆ config.TOKEN")

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")
app = Flask(__name__)

# ---------- Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ø­Ø§Ù„Ø© (state constants) ----------
STATE_REGISTER_NAME = "REGISTER_NAME"     # Ø¨Ø¹Ø¯ /start: Ù†Ù†ØªØ¸Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
STATE_REGISTER_GENDER = "REGISTER_GENDER" # Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù…: Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø¬Ù†Ø³ (Ø²Ø±)
STATE_REGISTER_AGE = "REGISTER_AGE"       # Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ù†Ø³: Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø¹Ù…Ø± (Ù†Øµ)
STATE_EDIT_NAME = "EDIT_NAME"             # Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"
STATE_EDIT_AGE = "EDIT_AGE"               # Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"
STATE_CHOOSE_TOPIC = "CHOOSE_TOPIC"
STATE_CHOOSE_TARGET_GENDER = "CHOOSE_TARGET_GENDER"
STATE_SEARCHING = "SEARCHING"
STATE_CONFIRM_LEAVE = "CONFIRM_LEAVE"
STATE_CONFIRM_REPORT = "CONFIRM_REPORT"

# ---------- Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ----------
def main_menu(in_chat: bool = False) -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¤ Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"), KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"))
    if in_chat:
        kb.add(KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"), KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    kb.add(KeyboardButton("ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©"))
    return kb

def topics_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    from config import TOPICS
    for i in range(0, len(TOPICS), 2):
        row = [KeyboardButton(TOPICS[i])]
        if i + 1 < len(TOPICS):
            row.append(KeyboardButton(TOPICS[i+1]))
        kb.add(*row)
    return kb

def gender_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for g in getattr(__import__("config"), "GENDERS", ["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰"]):
        kb.add(KeyboardButton(g))
    return kb

def target_gender_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for tg in getattr(__import__("config"), "TARGET_GENDERS", ["ğŸ‘¨ Ø±Ø¬Ù„", "ğŸ‘© Ø§Ù…Ø±Ø£Ø©"]):
        kb.add(KeyboardButton(tg))
    return kb

def yes_no_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("Ù†Ø¹Ù… âœ…"), KeyboardButton("Ù„Ø§ âŒ"))
    return kb

# ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† ----------
try:
    load_users()
except Exception as e:
    print(f"[LOAD_USERS ERROR] {e}")

# ---------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ----------
def update_user(uid: int, updates: dict):
    """
    ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­ÙØ¸Ù‡. ÙŠØ³ØªØ®Ø¯Ù… ensure_user Ù…Ù† profile (ÙŠØ¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø³Ø¬Ù„).
    """
    try:
        u = ensure_user(uid)
        u.update(updates)
        save_users()
    except Exception as e:
        # Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø®Ø·Ø£ ÙƒØ§Ù…Ù„Ù‹Ø§ Ù…Ø¹ stacktrace Ù„ØªØ´Ø®ÙŠØµ Ø£ÙØ¶Ù„
        print(f"[UPDATE_USER ERROR] {e} | uid={uid} | updates={updates}")
        print(traceback.format_exc())

def safe_send(uid: int, text: str, **kwargs):
    """
    ØºÙ„Ø§Ù Ù„Ù„Ø¥Ø±Ø³Ø§Ù„: Ù„Ø§ Ù†Ù…Ø±Ù‘Ø± 'delay' Ù‡Ù†Ø§Ø› messages.delayed_send ÙŠØ³ØªÙ‚Ø¨Ù„ (bot, chat_id, text, **kwargs)
    """
    try:
        # Ø§Ø³ØªØ¹Ù…Ù„ delayed_send Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§ (Ù‡Ùˆ Ø£ÙØ¶Ù„ Ù„Ù…Ù†Ø¹ Ø­Ø¸Ø± Ø§Ù„Ù€ API Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ù…ØªÙƒØ±Ø±)
        try:
            delayed_send(bot, uid, text, **kwargs)
        except Exception:
            # Ù†Ø±Ø¬Ø¹ Ù„bot.send_message Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            bot.send_message(uid, text, **kwargs)
    except Exception as e:
        print(f"[SEND_MESSAGE ERROR] {e} | chat_id={uid} | text_preview={str(text)[:120]}")
        print(traceback.format_exc())

# ---------- Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ ----------
def _topic_key(topic_text: str) -> str:
    if not topic_text:
        return ""
    parts = topic_text.split()
    return parts[-1] if parts else topic_text

# ---------------------------
# ---------- Handlers ----------
# ---------------------------

# /start
@bot.message_handler(commands=["start"])
def cmd_start(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    print(f"[START] user={uid}")

    # Ø£Ø±Ø³Ù„ Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¥Ù† ÙƒØ§Ù† get_welcome_message Ù…ØªØ§Ø­)
    try:
        safe_send(uid, get_welcome_message("START"))
    except Exception as e:
        print(f"[START SEND ERROR] {e}")

    # Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³Ù… Ø«Ù… Ø§Ø³Ø£Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
    try:
        update_user(uid, {"state": STATE_REGISTER_NAME})
    except Exception as e:
        print(f"[UPDATE USER (START) ERROR] {e}")

    try:
        safe_send(uid, "âœï¸ Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ", reply_markup=ReplyKeyboardRemove())
    except Exception as e:
        print(f"[ASK NAME ERROR] {e}")

# /help
@bot.message_handler(commands=["help"])
def cmd_help(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users.get(uid, {})
    if u.get("banned_full"):
        return
    safe_send(uid, HELP, reply_markup=main_menu(in_chat=bool(u.get("partner"))))

# ping Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
@bot.message_handler(commands=["ping"])
def cmd_ping(m: Message):
    try:
        cid = m.chat.id
        print(f"[DEBUG] ping from {cid}")
        bot.send_message(cid, "pong")
    except Exception as e:
        print(f"[ERROR] ping handler: {e}")

# /profile
@bot.message_handler(commands=["profile"])
def cmd_profile(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]
    safe_send(uid, profile_text(u), reply_markup=main_menu(in_chat=bool(u.get("partner"))))

# /search (Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©) â€” Ù…Ø±Ø§Ø¯Ù Ù„Ø²Ø± "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"
@bot.message_handler(commands=["search", "chat", "find"])
def cmd_search(m: Message):
    uid = m.from_user.id
    handle_search_request(uid)

# /leave
@bot.message_handler(commands=["leave", "exit"])
def cmd_leave(m: Message):
    uid = m.from_user.id
    handle_leave_request(uid)

# /report
@bot.message_handler(commands=["report"])
def cmd_report(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    update_user(uid, {"state": STATE_CONFIRM_REPORT})
    safe_send(uid, REPORT_CONFIRM, reply_markup=yes_no_menu())

# Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙŠ Ù†Øµ
@bot.message_handler(func=lambda msg: True, content_types=["text"])
def on_text(m: Message):
    uid = m.from_user.id
    txt = (m.text or "").strip()
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return

    state = u.get("state") or ""
    print(f"[MSG] from={uid} state={state} text={txt[:80]}")

    # ---------- Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ù„Ø§Ø³Ù… -> Ø§Ù„Ø¬Ù†Ø³ -> Ø§Ù„Ø¹Ù…Ø±) ----------
    if state == STATE_REGISTER_NAME:
        handle_register_name(uid, txt); return
    if state == STATE_REGISTER_GENDER:
        handle_register_gender(uid, txt); return
    if state == STATE_REGISTER_AGE:
        handle_register_age(uid, txt); return

    # ---------- Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ----------
    if state == STATE_EDIT_NAME:
        handle_edit_name(uid, txt); return
    if state == STATE_EDIT_AGE:
        handle_edit_age(uid, txt); return

    # ---------- Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ----------
    if state == STATE_CHOOSE_TOPIC:
        handle_topic_selection(uid, txt); return
    if state == STATE_CHOOSE_TARGET_GENDER:
        handle_target_gender(uid, txt); return
    if state == STATE_CONFIRM_LEAVE:
        handle_leave_confirm(uid, u, txt); return
    if state == STATE_CONFIRM_REPORT:
        handle_report_text_confirm(uid, u, txt); return

    # ---------- Ø£ÙˆØ§Ù…Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¹Ø¨Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ----------
    if txt == "ğŸ‘¤ Ù…Ù„ÙÙŠ":
        safe_send(uid, profile_text(u), reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        update_user(uid, {"state": STATE_EDIT_NAME})
        safe_send(uid, "âœï¸ Ø£Ø±Ø³Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", reply_markup=ReplyKeyboardRemove())
        return

    if txt == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        update_user(uid, {"state": STATE_EDIT_AGE})
        safe_send(uid, "ğŸ‚ Ø£Ø±Ø³Ù„ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (10â€“120):", reply_markup=ReplyKeyboardRemove())
        return

    if txt == "ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©":
        safe_send(uid, HELP, reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return

    if txt == "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©":
        handle_search_request(uid); return

    # Ø¥Ù† ÙƒØ§Ù† ÙÙŠ Ø¯Ø±Ø¯Ø´Ø©ØŒ Ù…Ø±Ù‘Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø´Ø±ÙŠÙƒ
    if u.get("partner"):
        handle_chat_message(uid, txt, u); return

    # Ø§ÙØªØ±Ø§Ø¶ÙŠ
    safe_send(uid, "â” Ù„Ù… Ø£ÙÙ‡Ù…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„.", reply_markup=main_menu(in_chat=False))

# ---------------------------
# Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
# ---------------------------

def handle_register_name(uid: int, txt: str):
    # Ø§Ø³ØªØ®Ø¯Ù… set_user_name Ù…Ù† profile.py
    try:
        ok = set_user_name(uid, txt)
        if not ok:
            safe_send(uid, "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ø³ØªØ®Ø¯Ù… 2â€“30 Ø­Ø±ÙÙ‹Ø§ (Ø­Ø±ÙˆÙ ÙˆÙ…Ø³Ø§ÙØ§Øª ÙÙ‚Ø·). Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:")
            return
        update_user(uid, {"state": STATE_REGISTER_GENDER})
        safe_send(uid, f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…: {users[uid].get('name')}")
        # Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¬Ù†Ø³ Ù…Ø¹ Ù„ÙˆØ­Ø© Ø£Ø²Ø±Ø§Ø±
        safe_send(uid, "ğŸ’¡ Ø§Ø®ØªØ± Ø¬Ù†Ø³Ùƒ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©):", reply_markup=gender_menu())
    except Exception as e:
        print(f"[handle_register_name ERROR] {e}")
        print(traceback.format_exc())
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")

def handle_register_gender(uid: int, txt: str):
    try:
        txt = txt.strip()
        valid = getattr(__import__("config"), "GENDERS", ["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰"])
        if txt not in valid:
            safe_send(uid, "âŒ Ø§Ø®ØªØ±: Ø°ÙƒØ± / Ø£Ù†Ø«Ù‰", reply_markup=gender_menu())
            return
        ok = set_user_gender(uid, txt)
        if not ok:
            safe_send(uid, "âŒ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ø®ØªØ±: Ø°ÙƒØ± / Ø£Ù†Ø«Ù‰", reply_markup=gender_menu())
            return
        update_user(uid, {"state": STATE_REGISTER_AGE})
        safe_send(uid, f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù†Ø³: {txt}")
        safe_send(uid, "ğŸ‚ Ù…Ø§ Ø¹Ù…Ø±ÙƒØŸ (10â€“120)", reply_markup=ReplyKeyboardRemove())
    except Exception as e:
        print(f"[handle_register_gender ERROR] {e}")
        print(traceback.format_exc())
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ù†Ø³. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")

def handle_register_age(uid: int, txt: str):
    try:
        ok = set_user_age(uid, txt)
        if not ok:
            safe_send(uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:")
            return
        update_user(uid, {"state": None})
        safe_send(uid, f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ø±: {users[uid].get('age')}")
        safe_send(uid, "ğŸ‰ ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", reply_markup=main_menu(in_chat=False))
    except Exception as e:
        print(f"[handle_register_age ERROR] {e}")
        print(traceback.format_exc())
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ø±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")

# ---------------------------
# Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±)
# ---------------------------

def handle_edit_name(uid: int, txt: str):
    try:
        ok = set_user_name(uid, txt)
        if not ok:
            safe_send(uid, "âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§:")
            return
        update_user(uid, {"state": None})
        safe_send(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰: {users[uid].get('name')}", reply_markup=main_menu(in_chat=False))
    except Exception as e:
        print(f"[handle_edit_name ERROR] {e}")
        print(traceback.format_exc())
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù….")

def handle_edit_age(uid: int, txt: str):
    try:
        ok = set_user_age(uid, txt)
        if not ok:
            safe_send(uid, "âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:")
            return
        update_user(uid, {"state": None})
        safe_send(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ø± Ø¥Ù„Ù‰: {users[uid].get('age')}", reply_markup=main_menu(in_chat=False))
    except Exception as e:
        print(f"[handle_edit_age ERROR] {e}")
        print(traceback.format_exc())
        safe_send(uid, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±.")

# ---------------------------
# Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø© Ùˆ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
# ---------------------------

def handle_search_request(uid: int):
    ensure_user(uid)
    u = users[uid]
    if u.get("partner"):
        safe_send(uid, "âš ï¸ Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø©!", reply_markup=main_menu(in_chat=True))
        return
    update_user(uid, {"state": STATE_CHOOSE_TOPIC})
    safe_send(uid, "Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø´:", reply_markup=topics_menu())

def handle_topic_selection(uid: int, txt: str):
    txt = txt.strip()
    from config import TOPICS
    if txt not in TOPICS:
        safe_send(uid, "âŒ Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", reply_markup=topics_menu())
        return
    update_user(uid, {"topic": txt, "state": STATE_CHOOSE_TARGET_GENDER})
    safe_send(uid, f"ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: {txt}\nØ§Ù„Ø¢Ù† Ø§Ø®ØªØ± Ø¬Ù†Ø³ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡:", reply_markup=target_gender_menu())

def handle_target_gender(uid: int, txt: str):
    txt = txt.strip()
    valid = getattr(__import__("config"), "TARGET_GENDERS", ["ğŸ‘¨ Ø±Ø¬Ù„", "ğŸ‘© Ø§Ù…Ø±Ø£Ø©"])
    if txt not in valid:
        safe_send(uid, f"âŒ Ø§Ø®ØªØ±: {' / '.join(valid)}", reply_markup=target_gender_menu())
        return

    # ØªØ­ÙˆÙŠÙ„ Ù„ØªÙ…Ø«ÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ
    if "Ø±Ø¬Ù„" in txt:
        target = "male"
    elif "Ø§Ù…Ø±Ø£Ø©" in txt or "Ø§Ù…Ø±Ø£" in txt:
        target = "female"
    else:
        target = "any"

    u = users[uid]
    topic = u.get("topic")
    update_user(uid, {"target_gender": target, "state": STATE_SEARCHING})

    # Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø®Ø§ØµØ© Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹ + Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«"
    safe_send(uid, get_welcome_message(_topic_key(topic)))
    safe_send(uid, SEARCHING, reply_markup=main_menu(in_chat=False))

    # Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ¬Ø±Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    try:
        add_to_wait(topic, uid, target)
    except Exception:
        try:
            add_to_wait(uid, topic, target)
        except Exception as e:
            print(f"[add_to_wait ERROR] {e}")
    # Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (ÙˆØ§Ø¬Ù‡Ø§Øª try_match Ù‚Ø¯ ØªØ®ØªÙ„Ù)
    partner = None
    try:
        partner = try_match(uid, topic)
    except Exception:
        try:
            partner = try_match(uid, topic, target)
        except Exception as e:
            print(f"[try_match ERROR] {e}")

    if partner:
        try:
            pid = int(partner)
            update_user(uid, {"partner": pid, "state": None, "chat_started_at": time.time()})
            update_user(pid, {"partner": uid, "state": None, "chat_started_at": time.time()})
            try:
                start_history(users[uid])
                start_history(users[pid])
            except Exception:
                pass
            safe_send(uid, INTRO_PARTNER, reply_markup=main_menu(in_chat=True))
            try:
                safe_send(pid, INTRO_PARTNER, reply_markup=main_menu(in_chat=True))
            except Exception:
                pass
        except Exception as e:
            print(f"[MATCH SETUP ERROR] {e}")

    # Ø´ØºÙ‘Ù„ ÙˆÙˆØªØ´Ø± Ù„Ù„ØªØ§ÙŠÙ… Ø¢ÙˆØª Ø¥Ù† ÙˆÙØ¬Ø¯
    try:
        start_timeout_watcher(bot)
    except Exception:
        try:
            start_timeout_watcher()
        except Exception as e:
            print(f"[start_timeout_watcher ERROR] {e}")

# ---------------------------
# Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
# ---------------------------

def handle_leave_request(uid: int):
    ensure_user(uid)
    u = users[uid]
    started = u.get("chat_started_at") or 0
    elapsed = time.time() - started
    if elapsed < getattr(__import__("config"), "LEAVE_DELAY", 30):
        safe_send(uid, LEAVE_TOO_SOON.format(remain=int(getattr(__import__("config"), "LEAVE_DELAY", 30) - elapsed)))
        return
    update_user(uid, {"state": STATE_CONFIRM_LEAVE})
    safe_send(uid, LEAVE_CONFIRM, reply_markup=yes_no_menu())

def handle_leave_confirm(uid: int, u: dict, txt: str):
    if txt == "Ù†Ø¹Ù… âœ…":
        pid = u.get("partner")
        if pid:
            try:
                # end_session ÙŠØªÙˆÙ‚Ø¹ user objects Ø£Ùˆ ids Ø­Ø³Ø¨ implemention
                try:
                    end_session(users[uid], users[pid])
                except Exception:
                    end_session(users.get(uid), users.get(pid))
            except Exception:
                pass
            update_user(uid, {"partner": None, "state": None, "chat_started_at": None})
            update_user(pid, {"partner": None, "state": None, "chat_started_at": None})
            safe_send(uid, "Ù„Ù‚Ø¯ ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", reply_markup=main_menu(in_chat=False))
            try:
                safe_send(pid, "Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", reply_markup=main_menu(in_chat=False))
            except Exception:
                pass
        else:
            update_user(uid, {"state": None})
            safe_send(uid, "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠ.")
    elif txt == "Ù„Ø§ âŒ":
        update_user(uid, {"state": None})
        safe_send(uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. ØªØ§Ø¨Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ‘Œ")
    else:
        safe_send(uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", reply_markup=yes_no_menu())

# ---------------------------
# ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº (Ù†Øµ)
# ---------------------------

def handle_report_text_confirm(uid: int, u: dict, txt: str):
    if txt == "Ù†Ø¹Ù… âœ…":
        pid = u.get("partner")
        try:
            result = review_history_and_penalize(uid, pid, u.get("history", []))
        except Exception as e:
            print(f"[review_history_and_penalize ERROR] {e}")
            result = None
        update_user(uid, {"state": None})
        safe_send(uid, REPORT_OK)
        if result:
            try:
                safe_send(uid, REPORT_RESULT.format(lines=result[0], respect=u.get("respect", "â€”")))
            except Exception:
                pass
    elif txt == "Ù„Ø§ âŒ":
        update_user(uid, {"state": None})
        safe_send(uid, "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒ.")
    else:
        safe_send(uid, "Ø§Ø®ØªØ±: Ù†Ø¹Ù… âœ… / Ù„Ø§ âŒ", reply_markup=yes_no_menu())
        return

    # Ø¨Ø¹Ø¯Ù‡Ø§ Ù†Ø¹Ø±Ø¶ Ø²Ø± "Ù…ØºØ§Ø¯Ø±Ø©" Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    safe_send(uid, "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¢Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŸ", reply_markup=kb)

# ---------------------------
# ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
# ---------------------------

def handle_chat_message(uid: int, txt: str, u: dict):
    if is_muted(uid):
        safe_send(uid, MUTED.format(left=60))
        return

    try:
        if contains_bad_word(txt):
            txt_to_send = censor_text(txt)
            safe_send(uid, "âš ï¸ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ø§Ø­ØªÙˆØ§Ø¦Ù‡Ø§ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ù„Ø§Ø¦Ù‚Ø©.")
        else:
            txt_to_send = txt
    except Exception:
        txt_to_send = txt

    try:
        apply_respect(uid, txt_to_send)
    except Exception:
        pass

    try:
        append_history(uid, txt_to_send)
    except Exception:
        pass

    pid = u.get("partner")
    if not pid or pid not in users:
        update_user(uid, {"partner": None})
        safe_send(uid, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠ â€” Ø¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", reply_markup=main_menu(in_chat=False))
        return

    try:
        bot.send_message(pid, f"ğŸ’¬ {txt_to_send}")
    except Exception as e:
        print(f"[SEND TO PARTNER ERROR] {e}")
        safe_send(uid, "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠÙƒ.")

# ---------------------------
# Webhook endpoint (Flask)
# ---------------------------

@app.route(f"/{getattr(__import__("config"), 'WEBHOOK_PATH', 'webhook')}", methods=["POST"])
def webhook():
    try:
        json_str = request.get_data().decode("utf-8")
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        print(f"[WEBHOOK PROCESS ERROR] {e}\n{traceback.format_exc()}")
    return "", 200

def set_webhook():
    url = os.environ.get("WEBHOOK_URL") or getattr(__import__("config"), "WEBHOOK_URL", None) if os.path.exists("config.py") else None
    path = getattr(__import__("config"), "WEBHOOK_PATH", "webhook") if os.path.exists("config.py") else "webhook"
    if not url:
        raise RuntimeError("WEBHOOK_URL Ù…ÙÙ‚ÙˆØ¯. Ø¶Ø¹Ù‡ ÙÙŠ Environment Ø£Ùˆ config.WEBHOOK_URL")
    try:
        bot.remove_webhook()
    except Exception:
        pass
    bot.set_webhook(f"{url}/{path}")
    print(f"[WEBHOOK] Set to {url}/{path}")

# ---------- ØªØ´ØºÙŠÙ„ watcher Ø¥Ù† ÙˆÙØ¬Ø¯ ----------
try:
    start_timeout_watcher(bot)
except Exception:
    try:
        start_timeout_watcher()
    except Exception as e:
        print(f"[start_timeout_watcher ERROR] {e}")

# ---------- Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ----------
if __name__ == "__main__":
    try:
        load_users()
    except Exception as e:
        print(f"[LOAD_USERS ERROR] {e}")
    try:
        set_webhook()
    except Exception as e:
        print(f"[WEBHOOK ERROR] {e}")
    port = int(os.environ.get("PORT", getattr(__import__("config"), "PORT", 5000)) if os.path.exists("config.py") else int(os.environ.get("PORT", 5000)))
    print(f"[RUN] Webhook listening on port {port}â€¦")
    app.run(host="0.0.0.0", port=port)
