# Main.py
import os
import telebot
from flask import Flask, request
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, Message

from config import TOKEN, ADMIN_CHAT_ID, TOPICS, GENDERS, TARGET_GENDERS, LEAVE_DELAY, WEBHOOK_PATH
from storage import load_users, save_users, ensure_user, users
from Profile_manger import sanitize_name, sanitize_age, profile_text, append_history, end_session, start_history
from Moderation import is_muted, apply_respect, review_history_and_penalize
from Matchmaking import add_to_wait, try_match, start_timeout_watcher, remove_from_wait
from messages import (WELCOME, HELP, SEARCHING, INTRO_PARTNER, NO_MATCH,
                      LEAVE_CONFIRM, LEAVE_TOO_SOON, LEFT_YOU, LEFT_PARTNER,
                      REPORT_CONFIRM, REPORT_OK, REPORT_RESULT, MUTED, BANNED,
                      delayed_send, get_welcome_message)

if not TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN Ù…ÙÙ‚ÙˆØ¯. Ø£Ø¶ÙÙ‡ ÙÙŠ Render â†’ Environment.")

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")
app = Flask(__name__)

# ==================== Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ====================
def main_menu(in_chat: bool = False) -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¤ Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"), KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"))
    if in_chat:
        kb.add(KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"), KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    kb.add(KeyboardButton("ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©"))
    return kb

def topics_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for i in range(0, len(TOPICS), 2):
        row = [KeyboardButton(TOPICS[i])]
        if i + 1 < len(TOPICS):
            row.append(KeyboardButton(TOPICS[i+1]))
        kb.add(*row)
    return kb

def target_gender_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¨ Ø±Ø¬Ù„"), KeyboardButton("ğŸ‘© Ø§Ù…Ø±Ø£Ø©"))
    kb.add(KeyboardButton("Ø£ÙŠ"))
    return kb

def yes_no_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("Ù†Ø¹Ù… âœ…"), KeyboardButton("Ù„Ø§ âŒ"))
    return kb

# ==================== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ====================
@bot.message_handler(commands=["start"])
def cmd_start(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]

    if u.get("banned_full"):
        delayed_send(bot, uid, BANNED, delay=0.2)
        return

    # Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
    if not u.get("gender"):
        u["state"] = "AWAIT_GENDER"
        save_users()
        kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        kb.add(KeyboardButton("Ø°ÙƒØ±"), KeyboardButton("Ø£Ù†Ø«Ù‰"), KeyboardButton("Ø£Ø®Ø±Ù‰"))
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·):", delay=0.2, reply_markup=kb)
        return

    # Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¦Ø¯
    u["state"] = None
    save_users()
    delayed_send(bot, uid, "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯! Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", delay=0.2,
                 reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["help"])
def cmd_help(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return
    delayed_send(bot, uid, HELP, delay=0.2,
                 reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["profile"])
def cmd_profile(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    delayed_send(bot, uid, profile_text(users[uid]), delay=0.2,
                 reply_markup=main_menu(in_chat=bool(users[uid].get("partner"))))

# ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ ====================
@bot.message_handler(func=lambda msg: True, content_types=["text"])
def on_text(m: Message):
    uid = m.from_user.id
    txt = (m.text or "").strip()
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return

    state = u.get("state") or ""

    # Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    if state == "AWAIT_GENDER": handle_gender(uid, txt); return
    if state == "AWAIT_NAME": handle_name(uid, txt); return
    if state == "AWAIT_AGE": handle_age(uid, txt); return

    # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if txt == "ğŸ‘¤ Ù…Ù„ÙÙŠ":
        delayed_send(bot, uid, profile_text(u), delay=0.2,
                     reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return
    if txt == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        u["state"] = "EDIT_NAME"; save_users()
        delayed_send(bot, uid,"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:",delay=0.2,reply_markup=ReplyKeyboardRemove())
        return
    if state == "EDIT_NAME": handle_edit_name(uid, txt); return
    if txt == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        u["state"] = "EDIT_AGE"; save_users()
        delayed_send(bot, uid,"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (10â€“120):",delay=0.2,reply_markup=ReplyKeyboardRemove())
        return
    if state == "EDIT_AGE": handle_edit_age(uid, txt); return
    if txt == "ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©":
        delayed_send(bot, uid, HELP, delay=0.2,
# Main.py
import os
import time
import telebot
from flask import Flask, request
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, Message

from config import TOKEN, ADMIN_CHAT_ID, TOPICS, GENDERS, TARGET_GENDERS, LEAVE_DELAY, WEBHOOK_PATH
from storage import load_users, save_users, ensure_user, users
from Profile_manger import sanitize_name, sanitize_age, profile_text, append_history, end_session, start_history
from Moderation import is_muted, apply_respect, review_history_and_penalize
from Matchmaking import add_to_wait, try_match, start_timeout_watcher, remove_from_wait
from messages import (
    WELCOME, HELP, SEARCHING, INTRO_PARTNER, NO_MATCH,
    LEAVE_CONFIRM, LEAVE_TOO_SOON, LEFT_YOU, LEFT_PARTNER,
    REPORT_CONFIRM, REPORT_OK, REPORT_RESULT, MUTED, BANNED,
    delayed_send, get_welcome_message, GENERAL_WELCOME_MESSAGES
)

if not TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN Ù…ÙÙ‚ÙˆØ¯. Ø£Ø¶ÙÙ‡ ÙÙŠ Render â†’ Environment.")

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")
app = Flask(__name__)

# ==================== Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ====================
def main_menu(in_chat: bool = False) -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¤ Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…"), KeyboardButton("ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©"))
    if in_chat:
        kb.add(KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"), KeyboardButton("ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"))
    kb.add(KeyboardButton("ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©"))
    return kb

def topics_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for i in range(0, len(TOPICS), 2):
        row = [KeyboardButton(TOPICS[i])]
        if i + 1 < len(TOPICS):
            row.append(KeyboardButton(TOPICS[i+1]))
        kb.add(*row)
    return kb

def target_gender_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("ğŸ‘¨ Ø±Ø¬Ù„"), KeyboardButton("ğŸ‘© Ø§Ù…Ø±Ø£Ø©"))
    kb.add(KeyboardButton("Ø£ÙŠ"))
    return kb

def yes_no_menu() -> ReplyKeyboardMarkup:
    kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    kb.add(KeyboardButton("Ù†Ø¹Ù… âœ…"), KeyboardButton("Ù„Ø§ âŒ"))
    return kb

# ==================== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ====================
@bot.message_handler(commands=["start"])
def cmd_start(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]

    if u.get("banned_full"):
        delayed_send(bot, uid, BANNED, delay=0.4)
        return

    # Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
    if not u.get("gender"):
        # Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø«Ø§Ø¨ØªØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        fixed_welcome = "\n".join([
            "Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø§Ù„Ù‰ Ø·Ø±ÙŠÙ‚ Ù…Ø³Ø¯ÙˆØ¯.. Ø¨Ø³ Ù…Ù†ÙØªØ­Ùˆ ÙƒØ±Ù…Ø§Ù„Ùƒ ğŸ˜",
            "ØªÙØ¶Ù„ ÙŠØ§ Ù…ÙˆÙ„Ø§ÙŠ...",
            "Ù‡ÙˆÙˆÙˆÙˆÙˆØ¨ Ø´Ù„Ø§Ø­ Ù…Ù† Ø±Ø¬Ù„Ùƒ ÙˆÙÙˆØª ÙŠØ§ Ù…ÙˆÙ„Ø§ÙŠ",
            "Ø´Ù„Ø§Ø­ ÙˆÙ„Ø§Ø§Ø§Ùƒ............. Ù…Ù† Ø±Ø¬Ù„Ùƒ Ù…Ù† Ø±Ø¬Ù„Ùƒ ğŸ˜‚",
            "Ø§ÙŠ ØªÙØ¶Ù„ ØªÙØ¶Ù„ ØªÙØ¶Ù„ â¤ï¸â¤ï¸"
        ])
        delayed_send(bot, uid, fixed_welcome, delay=0.4, reply_markup=ReplyKeyboardRemove())

        u["state"] = "AWAIT_GENDER"
        save_users()
        kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        kb.add(KeyboardButton("Ø°ÙƒØ±"), KeyboardButton("Ø£Ù†Ø«Ù‰"), KeyboardButton("Ø£Ø®Ø±Ù‰"))
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·):", delay=0.8, reply_markup=kb)
        return

    # Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¦Ø¯
    u["state"] = None
    save_users()
    delayed_send(bot, uid, f"Ù…Ø±Ø­Ø¨Ù‹Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯! Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", delay=0.4,
                 reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["help"])
def cmd_help(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return
    delayed_send(bot, uid, HELP, delay=0.2,
                 reply_markup=main_menu(in_chat=bool(u.get("partner"))))

@bot.message_handler(commands=["profile"])
def cmd_profile(m: Message):
    uid = m.from_user.id
    ensure_user(uid)
    delayed_send(bot, uid, profile_text(users[uid]), delay=0.2,
                 reply_markup=main_menu(in_chat=bool(users[uid].get("partner"))))

# ==================== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ ====================
@bot.message_handler(func=lambda msg: True, content_types=["text"])
def on_text(m: Message):
    uid = m.from_user.id
    txt = (m.text or "").strip()
    ensure_user(uid)
    u = users[uid]
    if u.get("banned_full"):
        return

    state = u.get("state") or ""

    # Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    if state == "AWAIT_GENDER": handle_gender(uid, txt); return
    if state == "AWAIT_NAME": handle_name(uid, txt); return
    if state == "AWAIT_AGE": handle_age(uid, txt); return

    # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if txt == "ğŸ‘¤ Ù…Ù„ÙÙŠ":
        delayed_send(bot, uid, profile_text(u), delay=0.2,
                     reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return
    if txt == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        u["state"] = "EDIT_NAME"; save_users()
        delayed_send(bot, uid,"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:",delay=0.2,reply_markup=ReplyKeyboardRemove())
        return
    if state == "EDIT_NAME": handle_edit_name(uid, txt); return
    if txt == "ğŸ‚ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        u["state"] = "EDIT_AGE"; save_users()
        delayed_send(bot, uid,"Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (10â€“120):",delay=0.2,reply_markup=ReplyKeyboardRemove())
        return
    if state == "EDIT_AGE": handle_edit_age(uid, txt); return
    if txt == "ğŸ†˜ Ù…Ø³Ø§Ø¹Ø¯Ø©":
        delayed_send(bot, uid, HELP, delay=0.2,
                     reply_markup=main_menu(in_chat=bool(u.get("partner"))))
        return
    if txt == "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©": handle_search_request(uid); return

    # Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¶ÙˆØ¹ / Ø§Ù„ÙØ¦Ø©
    if state in ["CHOOSE_TOPIC", "CHOOSE_TARGET_GENDER"]:
        handle_topic_selection(uid, txt); return

    # Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    if u.get("partner"): handle_chat_message(uid, txt, u); return

    # Ø§ÙØªØ±Ø§Ø¶ÙŠ
    delayed_send(bot, uid, "â” Ù„Ù… Ø£ÙÙ‡Ù…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„.", delay=0.2,
                 reply_markup=main_menu(in_chat=False))

# ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ========
def handle_gender(uid, txt):
    u = users[uid]
    if txt not in GENDERS:
        kb = ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        kb.add(KeyboardButton("Ø°ÙƒØ±"), KeyboardButton("Ø£Ù†Ø«Ù‰"), KeyboardButton("Ø£Ø®Ø±Ù‰"))
        delayed_send(bot, uid, "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±: Ø°ÙƒØ± / Ø£Ù†Ø«Ù‰ / Ø£Ø®Ø±Ù‰", delay=0.3, reply_markup=kb)
        return
    u["gender"]=txt; u["state"]="AWAIT_NAME"; save_users()
    delayed_send(bot, uid, "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ (Ù¢â€“Ù£Ù  Ø­Ø±ÙÙ‹Ø§ØŒ Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…):", delay=0.3, reply_markup=ReplyKeyboardRemove())

def handle_name(uid, txt):
    u = users[uid]
    name = sanitize_name(txt)
    if not name: delayed_send(bot, uid,"âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§:",delay=0.3); return
    u["name"]=name; u["state"]="AWAIT_AGE"; save_users()
    delayed_send(bot, uid,"Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ (10â€“120):",delay=0.3)

def handle_age(uid, txt):
    u = users[uid]
    age = sanitize_age(txt)
    if age is None:
        delayed_send(bot, uid,"âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:",delay=0.3)
        return
    u["age"] = age
    u["state"] = None
    save_users()

    # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­Ø³Ø¨ topic Ø¥Ø°Ø§ Ø§Ø®ØªÙŠØ±ØŒ Ø£Ùˆ ØªØ±Ø­ÙŠØ¨ Ø«Ø§Ø¨Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    topic = u.get("topic")
    if topic:
        delayed_send(bot, uid, get_welcome_message(topic=topic), delay=0.4)
    delayed_send(bot, uid,"âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸.\n"+profile_text(u),delay=0.4,reply_markup=main_menu(in_chat=False))
    delayed_send(bot, uid,"Ø§Ø¶ØºØ·: ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù†Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØªÙƒ.",delay=0.5)

# Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØŒ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ WebhookØŒ Ø¥Ù„Ø®) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
# ÙÙ‚Ø· ØªØ£ÙƒØ¯ Ø£Ù† ÙƒÙ„ Ø¯Ø§Ù„Ø© ØªØ³ØªØ¯Ø¹ÙŠ delayed_send() Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø§Ù„Ø©

# ==================== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù…Ø± ====================
def handle_edit_name(uid, txt):
    u = users[uid]; name = sanitize_name(txt)
    if not name: delayed_send(bot, uid,"âŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§:",delay=0.2); return
    u["name"] = name; u["state"] = None; save_users()
    delayed_send(bot, uid,"âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.\n"+profile_text(u),delay=0.2,reply_markup=main_menu(in_chat=bool(u.get("partner"))))

def handle_edit_age(uid, txt):
    u = users[uid]; age = sanitize_age(txt)
    if age is None: delayed_send(bot, uid,"âŒ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 10 Ùˆ120:",delay=0.2); return
    u["age"] = age; u["state"] = None; save_users()
    delayed_send(bot, uid,"âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«.\n"+profile_text(u),delay=0.2,reply_markup=main_menu(in_chat=bool(u.get("partner"))))

# ==================== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø© ====================
def handle_search_request(uid):
    u = users[uid]
    if not (u.get("gender") and u.get("name") and u.get("age")):
        delayed_send(bot, uid,"âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ø¹Ø¨Ø± /start.",delay=0.2); return
    u["state"]="CHOOSE_TOPIC"; save_users()
    delayed_send(bot, uid,"Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø´:",delay=0.2,reply_markup=topics_menu())

def handle_topic_selection(uid, txt):
    u = users[uid]
    if u["state"]=="CHOOSE_TOPIC":
        if txt not in TOPICS: delayed_send(bot, uid,"âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±:",delay=0.2,reply_markup=topics_menu()); return
        u["topic"]=txt; u["state"]="CHOOSE_TARGET_GENDER"; save_users()
        delayed_send(bot, uid,"Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹Ù‡:",delay=0.2,reply_markup=target_gender_menu())
        return
    if u["state"]=="CHOOSE_TARGET_GENDER":
        if txt not in TARGET_GENDERS: delayed_send(bot, uid,"âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±:",delay=0.2,reply_markup=target_gender_menu()); return
        u["search_pref"]="Ø£ÙŠ" if txt=="Ø£ÙŠ" else txt; u["state"]=None; save_users()
        add_to_wait(u["topic"], uid, u["search_pref"])
        delayed_send(bot, uid, SEARCHING, delay=0.2, reply_markup=main_menu(in_chat=False))
        partner_id = try_match(uid, u["topic"])
        if partner_id: start_chat(uid, partner_id)

# ==================== Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====================
# ... Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ ...
# handle_chat_message, handle_leave_request, handle_leave_confirm, handle_report, start_chat
# ==================== Webhook + Flask ====================
@app.route(f"/{WEBHOOK_PATH}", methods=["POST"])
def webhook():
    json_str = request.get_data().decode("utf-8")
    update = telebot.types.Update.de_json(json_str)
    bot.process_new_updates([update])
    return "", 200

def set_webhook():
    url = os.environ.get("WEBHOOK_URL")
    if not url:
        raise RuntimeError("WEBHOOK_URL Ù…ÙÙ‚ÙˆØ¯. Ø£Ø¶ÙÙ‡ ÙÙŠ Environment Variables ÙÙŠ Render.")
    bot.remove_webhook()
    bot.set_webhook(f"{url}/{WEBHOOK_PATH}")
    print(f"[WEBHOOK] Set to {url}/{WEBHOOK_PATH}")

# ==================== Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================
if __name__ == "__main__":
    load_users()
    try:
        set_webhook()
    except Exception as e:
        print(f"[WEBHOOK ERROR] {e}")

    start_timeout_watcher(bot)

    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port) 
