import os
import time
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("Ø¶Ø¹ TELEGRAM_TOKEN ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")

bot = telebot.TeleBot(TOKEN)

# ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© =====
users = {}  # user_id -> {"name":.., "age":.., "gender":.., "respect":.., "gender_changes":0, "profile_locked":False}
waiting_users = { (topic, gender): [] for topic in ["ÙÙ„Ø³ÙØ©","Ø±ÙŠØ§Ø¶Ø©","Ø¯ÙŠÙ†","Ø³ÙŠØ§Ø³Ø©","ØªØ¹Ø§Ø±Ù"] for gender in ["Ø°ÙƒØ±","Ø£Ù†Ø«Ù‰"] }
active_chats = {}  # user_id -> partner_id
chat_logs = {}  # user_id -> [last 50 messages]
leave_timers = {}  # user_id -> ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
warnings_sent = set()
banned_users = {}  # user_id -> ban_end_timestamp

# ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø© =====
bad_words = [
    "ÙƒØ³","ÙƒØ³Ù…Ùƒ","ÙƒØ³ÙŠ","ÙƒØ³Ø³","ÙƒØ³Ø³Ø³","ÙƒØ³Ø³Ø³Ø³","ÙƒØ³Ù…Ùˆ","ÙƒØµÙ…Ùƒ","Ø§ÙŠØ±","Ø§ÙŠØ±ÙŠ","Ø§ÙŠØ±Ù†Ø§","Ø·ÙŠØ²Ù†Ø§","Ø·ÙŠØ²",
    "ÙƒØ³Ø®ØªÙƒ","ÙŠÙ„Ø¹Ù† Ø±Ø¨Ùƒ","ÙŠÙ„Ø¹Ù† Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø±ÙˆØ­Ùƒ","Ø¹Ù†Ø±Ø¨Ùƒ","Ø¹Ù†Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø´ÙØ±Ø§ØªÙƒ","Ù‚Ø­Ø¨Ø©","Ø´Ø±Ù…ÙˆØ·Ø©",
    "Ø´Ù„ÙƒØ©","Ù…Ù†ØªØ§ÙƒØ©","Ø³Ø±Ù…ÙˆØ·Ø©","Ù‚Ø­Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù…Ù†ÙŠÙƒ","Ù…ÙƒØ³ÙƒØ³"
]

# ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def get_penalty(respect, bad_count):
    penalty = 0
    if respect >= 76:
        penalty = bad_count // 2
    elif 71 <= respect <= 75:
        penalty = bad_count
    elif 61 <= respect <= 70:
        penalty = bad_count * 2
    elif 51 <= respect <= 60:
        penalty = bad_count * 3
    elif 41 <= respect <= 50:
        penalty = bad_count * 5
    elif 26 <= respect <= 40:
        penalty = bad_count * 10
    return penalty

def is_banned(user_id):
    if user_id in banned_users:
        if time.time() < banned_users[user_id]:
            return True
        else:
            del banned_users[user_id]
    return False

def add_message(user_id, text):
    if user_id not in chat_logs:
        chat_logs[user_id] = []
    chat_logs[user_id].append(text)
    if len(chat_logs[user_id]) > 50:
        chat_logs[user_id] = chat_logs[user_id][-50:]

# ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
def main_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"), KeyboardButton("ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"), KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø«"))
    return kb

# ===== Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
@bot.message_handler(commands=['start'])
def start(msg):
    user_id = msg.from_user.id
    if user_id not in users:
        users[user_id] = {"name": None, "age": None, "gender": None, "respect": 80, "gender_changes": 0, "profile_locked": False}
        bot.send_message(user_id, "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.\nÙ…Ø§ Ø§Ø³Ù…ÙƒØŸ", reply_markup=main_menu())
    else:
        bot.send_message(user_id, "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ!", reply_markup=main_menu())

# ===== Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
@bot.message_handler(func=lambda m: m.text == "ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ")
def profile_menu(msg):
    user = users.get(msg.from_user.id)
    if not user: return
    info = f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {user['age']}\nâš§ï¸ Ø§Ù„Ø¬Ù†Ø³: {user['gender']}\nâ­ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {user['respect']}"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(msg.chat.id, info, reply_markup=kb)

# ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
@bot.message_handler(func=lambda m: m.text in ["âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³"])
def edit_profile(msg):
    user_id = msg.from_user.id
    if msg.text == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…":
        bot.send_message(user_id, "Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", reply_markup=ReplyKeyboardMarkup(resize_keyboard=True))
    elif msg.text == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±":
        bot.send_message(user_id, "Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙƒØ±Ù‚Ù…:", reply_markup=ReplyKeyboardMarkup(resize_keyboard=True))
    elif msg.text == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù†Ø³":
        if users[user_id]["gender_changes"] >= 1:
            bot.send_message(user_id, "ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ù†Ø³ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©.")
            return
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.add("ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰")
        bot.send_message(user_id, "Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", reply_markup=kb)

# ===== Ø§Ù„Ø¨Ø­Ø« =====
TOPICS = ["ğŸ“š ÙÙ„Ø³ÙØ©","âš½ Ø±ÙŠØ§Ø¶Ø©","â˜ªï¸ Ø¯ÙŠÙ†","ğŸ› Ø³ÙŠØ§Ø³Ø©","ğŸ¤ ØªØ¹Ø§Ø±Ù"]

@bot.message_handler(func=lambda m: m.text == "ğŸ” Ø§Ù„Ø¨Ø­Ø«")
def search_menu(msg):
    user_id = msg.from_user.id
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for t in TOPICS:
        kb.add(t)
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(user_id, "Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙ†Ø§Ù‚Ø´ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø§Ø®ØªØ± Ù…Ø¬Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø´:", reply_markup=kb)

# ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³ Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =====
@bot.message_handler(func=lambda m: m.text in TOPICS)
def topic_choice(msg):
    topic = msg.text
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(f"{topic} ğŸ‘¨", f"{topic} ğŸ‘©")
    kb.add("â¬…ï¸ Ø±Ø¬ÙˆØ¹")
    bot.send_message(msg.chat.id, "Ø§Ø®ØªØ± Ù…Ø¹ Ù…Ù† ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯Ø«:", reply_markup=kb)

# ===== Ø§Ù„Ø¥Ø¨Ù„Ø§Øº =====
def check_respect_and_ban(user_id):
    respect = users[user_id]["respect"]
    if respect <= 25:
        banned_users[user_id] = float('inf')  # Ø­Ø¸Ø± Ø¯Ø§Ø¦Ù…
        bot.send_message(user_id, "â›” ØªÙ… Ø­Ø¸Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­.")
        return True
    elif respect <= 40:
        if user_id not in warnings_sent:
            banned_users[user_id] = time.time() + 7*24*3600  # Ø£Ø³Ø¨ÙˆØ¹ Ø­Ø¸Ø± Ù…Ø¤Ù‚Øª
            bot.send_message(user_id,
                "âš ï¸ ØªØ­Ø°ÙŠØ± Ø´Ø¯ÙŠØ¯! Ø§Ø­ØªØ±Ø§Ù…Ùƒ ÙˆØµÙ„ 40.\n"
                "Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù„Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø³Ø¨Ø¨ Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ù„Ø§Ø¦Ù‚.\n"
                "ØªØ¹Ù„Ù… Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙˆÙƒÙ† Ø£ÙƒØ«Ø± Ø£Ø®Ù„Ø§Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.\n"
                "Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø± Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø³Ù„Ø¨ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ 25 Ù†Ù‚Ø·Ø©.")
            warnings_sent.add(user_id)
            return True
    elif respect <= 50:
        if user_id not in warnings_sent:
            bot.send_message(user_id,
                "âš ï¸ ØªØ­Ø°ÙŠØ±! Ø§Ø­ØªØ±Ø§Ù…Ùƒ ÙˆØµÙ„ 50.\n"
                "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ«Ø± ØªÙ‡Ø°ÙŠØ¨Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ«.\n"
                "ÙƒÙ„ Ø³Ù„ÙˆÙƒ Ø³ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠ Ø³ÙŠØ®ØµÙ… Ù†Ù‚Ø§Ø· Ø£ÙƒØ«Ø± ÙˆÙ‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ù…Ø¤Ù‚Øª Ø£Ùˆ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.\n"
                "Ù†ØµØ§Ø¦Ø­: Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ù…Ø­ØªØ±Ù…Ø©ØŒ Ù„Ø§ ØªØ³Ø¨ Ø£Ùˆ ØªÙ‡ÙŠÙ†ØŒ ÙˆØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ù‚Ø§Ø´ Ø±Ø§Ù‚ÙŠÙ‹Ø§.")
            warnings_sent.add(user_id)
    return False

@bot.message_handler(func=lambda m: m.text == "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº")
def report_user(msg):
    user_id = msg.from_user.id
    if user_id not in active_chats:
        bot.send_message(user_id, "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¨Ø¯ÙˆÙ† ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø¯Ø´Ø©.")
        return
    partner_id = active_chats[user_id]
    messages = chat_logs.get(partner_id, [])
    bad_count = sum(1 for m in messages for w in bad_words if w in m)
    penalty = get_penalty(users[partner_id]["respect"], bad_count)
    users[partner_id]["respect"] -= penalty
    bot.send_message(user_id, f"âœ… ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº. Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø©: {bad_count}\nØ§Ù„Ø®ØµÙ…: {penalty} Ù†Ù‚Ø§Ø·.")
    bot.send_message(partner_id, "ğŸš¨ Ù„Ù‚Ø¯ ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ùƒ! Ø§Ù†ØªØ¨Ù‡ Ø¥Ù„Ù‰ Ø³Ù„ÙˆÙƒÙƒ.")
    check_respect_and_ban(partner_id)

# ===== Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =====
def start_chat(user_id, partner_id):
    active_chats[user_id] = partner_id
    active_chats[partner_id] = user_id
    leave_timers[user_id] = time.time()
    leave_timers[partner_id] = time.time()
    bot.send_message(user_id, "âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†.")
    bot.send_message(partner_id, "âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†.")

@bot.message_handler(func=lambda msg: any(t in msg.text for t in TOPICS))
def handle_topic_gender_choice(msg):
    user_id = msg.chat.id
    text = msg.text
    topic = None
    gender_pref = "Ø°ÙƒØ±" if "ğŸ‘¨" in text else "Ø£Ù†Ø«Ù‰"
    for t in ["ÙÙ„Ø³ÙØ©","Ø±ÙŠØ§Ø¶Ø©","Ø¯ÙŠÙ†","Ø³ÙŠØ§Ø³Ø©","ØªØ¹Ø§Ø±Ù"]:
        if t in text:
            topic = t
            break
    if topic is None: return
    opposite_gender = "Ø£Ù†Ø«Ù‰" if users[user_id]["gender"] == "Ø°ÙƒØ±" else "Ø°ÙƒØ±"
    key = (topic, opposite_gender)
    if waiting_users[key]:
        partner_id = waiting_users[key].pop(0)
        start_chat(user_id, partner_id)
        bot.send_message(user_id, f"ğŸ‰ ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ!\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {users[partner_id]['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {users[partner_id]['age']}\nâ­ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {users[partner_id]['respect']}")
        bot.send_message(partner_id, f"ğŸ‰ ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø´Ø±ÙŠÙƒ!\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {users[user_id]['name']}\nğŸ‚ Ø§Ù„Ø¹Ù…Ø±: {users[user_id]['age']}\nâ­ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {users[user_id]['respect']}")
    else:
        waiting_users[(topic, users[user_id]["gender"])].append(user_id)
        bot.send_message(user_id, "â³ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø³ÙŠØªÙ… Ù…Ø·Ø§Ø¨Ù‚ØªÙƒ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø´Ø®Øµ Ù…Ù†Ø§Ø³Ø¨.")

# ===== Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙŠÙƒÙŠÙ† =====
@bot.message_handler(func=lambda msg: True)
def relay(msg):
    user_id = msg.chat.id
    text = msg.text
    if is_banned(user_id):
        bot.send_message(user_id, "â›” Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return
    add_message(user_id, text)

    # Ø®ØµÙ… Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¯ÙŠØ«
    bad_count = sum(1 for w in bad_words if w in text)
    if bad_count > 0:
        users[user_id]["respect"] -= get_penalty(users[user_id]["respect"], bad_count)
        check_respect_and_ban(user_id)

    if user_id in active_chats:
        partner_id = active_chats[user_id]
        sender_name = users[user_id]["name"] or "Ù…Ø³ØªØ®Ø¯Ù…"
        bot.send_message(partner_id, f"ğŸ’¬ {sender_name}: {text}")
    else:
        bot.send_message(user_id, "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ù†Ø´Ø·ØŒ Ø§Ø¶ØºØ· ğŸ” Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ.")

# ===== Ø²Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© =====
@bot.message_handler(func=lambda msg: msg.text == "âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª")
def leave_chat(msg):
    user_id = msg.chat.id
    if user_id not in active_chats:
        bot.send_message(user_id, "â„¹ï¸ Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return
    elapsed = time.time() - leave_timers.get(user_id, 0)
    if elapsed < 30:
        bot.send_message(user_id, f"â³ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù‚Ø¨Ù„ 30 Ø«Ø§Ù†ÙŠØ©. ØªØ¨Ù‚Ù‰ {int(30 - elapsed)} Ø«Ø§Ù†ÙŠØ©.")
        return
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ğŸšª", callback_data=f"confirm_leave_{user_id}"))
    bot.send_message(user_id, "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith("confirm_leave_"))
def confirm_leave(call):
    user_id = int(call.data.split("_")[-1])
    if user_id not in active_chats:
        bot.answer_callback_query(call.id, "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.")
        return
    partner_id = active_chats[user_id]
    bot.send_message(user_id, "ğŸšª ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    bot.send_message(partner_id, "ğŸšª Ø´Ø±ÙŠÙƒÙƒ ØºØ§Ø¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
    for uid in [user_id, partner_id]:
        active_chats.pop(uid, None)
        leave_timers.pop(uid, None)

print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
bot.infinity_polling(skip_pending=True)
