import os
import time
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
TOKEN = os.environ.get("TELEGRAM_TOKEN")  # Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ø¯Ø§Ø®Ù„ Render
if not TOKEN:
    raise RuntimeError("Ø¶Ø¹ TELEGRAM_TOKEN ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¹Ù„Ù‰ Render")

bot = telebot.TeleBot(TOKEN)

# ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© =====
users = {}  # ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
chats = {}  # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©
reports = []  # Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

# ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø© =====
bad_words = ["fuck", "shit", "bitch", "asshole", "dick", "pussy", "motherfucker",
             "Ù„Ø¹Ù†Ø©", "Ø²Ù‚", "Ù‚Ø­Ø¨Ø©", "ÙƒØ³", "Ù†ÙŠÙƒ", "Ø´Ø±Ù…ÙˆØ·", "ÙƒÙ„Ø¨", "Ø­Ù…Ø§Ø±"]

# ===== Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
def create_user(user_id):
    return {
        "name": None,
        "age": None,
        "gender": None,   # Ù„Ø§ ÙŠØªØºÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        "topic": None,
        "respect": 80,
        "warnings": 0,
        "banned_until": None,
        "chat_partner": None,
        "messages": []
    }

# ===== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
@bot.message_handler(commands=["start"])
def start(message):
    user_id = message.from_user.id
    if user_id not in users:
        users[user_id] = create_user(user_id)
        bot.send_message(user_id,
                         "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø°ÙƒÙŠ!\n\n"
                         "Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø£ÙˆÙ„Ø§Ù‹.\n"
                         "Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù…ÙƒØŸ")
        bot.register_next_step_handler(message, set_name)
    else:
        bot.send_message(user_id, "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹! âœ…\nØ§Ø³ØªØ®Ø¯Ù… /menu Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª.")

# ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
def set_name(message):
    user_id = message.from_user.id
    name = message.text.strip()
    if not name or len(name) < 2:
        bot.send_message(user_id, "âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:")
        return bot.register_next_step_handler(message, set_name)
    users[user_id]["name"] = name
    bot.send_message(user_id, "ğŸ“… Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ:")
    bot.register_next_step_handler(message, set_age)

def set_age(message):
    user_id = message.from_user.id
    try:
        age = int(message.text.strip())
        if age < 10 or age > 100:
            raise ValueError
        users[user_id]["age"] = age
        # Ø§Ù„Ø¬Ù†Ø³ ÙŠÙØ·Ù„Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        markup = ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
        markup.add("ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰")
        bot.send_message(user_id, "ğŸ‘¤ Ø§Ø®ØªØ± Ø¬Ù†Ø³Ùƒ (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹):", reply_markup=markup)
        bot.register_next_step_handler(message, set_gender)
    except ValueError:
        bot.send_message(user_id, "âš ï¸ Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ ÙƒØ¹Ø¯Ø¯ ØµØ­ÙŠØ­ (10-100):")
        bot.register_next_step_handler(message, set_age)

def set_gender(message):
    user_id = message.from_user.id
    gender = message.text.strip()
    if gender not in ["ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰"]:
        bot.send_message(user_id, "âš ï¸ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·:")
        return bot.register_next_step_handler(message, set_gender)
    users[user_id]["gender"] = gender
    # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©
    markup = ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
    markup.add("ğŸ’­ ÙÙ„Ø³ÙØ©", "ğŸ™ Ø¯ÙŠÙ†", "ğŸ›ï¸ Ø³ÙŠØ§Ø³Ø©", "ğŸ¤ ØªØ¹Ø§Ø±Ù", "âš½ Ø±ÙŠØ§Ø¶Ø©")
    bot.send_message(user_id, "Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ù†Ù‚Ø§Ø´ Ø§Ù„ØªÙŠ ØªÙØ¶Ù„Ù‡Ø§:", reply_markup=markup)
    bot.register_next_step_handler(message, set_topic)

def set_topic(message):
    user_id = message.from_user.id
    topic = message.text.strip()
    if topic not in ["ğŸ’­ ÙÙ„Ø³ÙØ©", "ğŸ™ Ø¯ÙŠÙ†", "ğŸ›ï¸ Ø³ÙŠØ§Ø³Ø©", "ğŸ¤ ØªØ¹Ø§Ø±Ù", "âš½ Ø±ÙŠØ§Ø¶Ø©"]:
        bot.send_message(user_id, "âš ï¸ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·:")
        return bot.register_next_step_handler(message, set_topic)
    users[user_id]["topic"] = topic
    bot.send_message(user_id, "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!\n"
                              "Ø§Ø³ØªØ®Ø¯Ù… /menu Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª.", reply_markup=ReplyKeyboardRemove())

# ===== Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
@bot.message_handler(commands=["menu"])
def menu(message):
    user_id = message.from_user.id
    if user_id not in users or not users[user_id]["topic"]:
        return bot.send_message(user_id, "âš ï¸ ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± /start")

    markup = ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ‘¤ Ø¹Ø±Ø¶ Ù…Ù„ÙÙŠ", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±")
    markup.add("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©")
    bot.send_message(user_id, "ğŸ“Œ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:", reply_markup=markup)

# ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
@bot.message_handler(func=lambda m: m.text == "ğŸ‘¤ Ø¹Ø±Ø¶ Ù…Ù„ÙÙŠ")
def show_profile(message):
    user_id = message.from_user.id
    u = users[user_id]
    bot.send_message(user_id,
                     f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {u['name']}\n"
                     f"ğŸ“… Ø§Ù„Ø¹Ù…Ø±: {u['age']}\n"
                     f"{u['gender']}\n"
                     f"ğŸ¯ Ø§Ù„ÙØ¦Ø©: {u['topic']}\n"
                     f"ğŸ’¯ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {u['respect']}")

# ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù…Ø± =====
@bot.message_handler(func=lambda m: m.text == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¹Ù…Ø±")
def edit_profile(message):
    markup = ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
    markup.add("âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…", "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±")
    bot.send_message(message.chat.id, "Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ØŸ", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…")
def edit_name(message):
    user_id = message.from_user.id
    bot.send_message(user_id, "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
    bot.register_next_step_handler(message, save_new_name)

def save_new_name(message):
    user_id = message.from_user.id
    name = message.text.strip()
    if not name or len(name) < 2:
        bot.send_message(user_id, "âš ï¸ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­.")
        return
    users[user_id]["name"] = name
    bot.send_message(user_id, "âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­.")

@bot.message_handler(func=lambda m: m.text == "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±")
def edit_age(message):
    user_id = message.from_user.id
    bot.send_message(user_id, "Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
    bot.register_next_step_handler(message, save_new_age)

def save_new_age(message):
    user_id = message.from_user.id
    try:
        age = int(message.text.strip())
        if age < 10 or age > 100:
            raise ValueError
        users[user_id]["age"] = age
        bot.send_message(user_id, "âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­.")
    except ValueError:
        bot.send_message(user_id, "âš ï¸ Ø§Ù„Ø¹Ù…Ø± ØºÙŠØ± ØµØ§Ù„Ø­.")

# ===== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø© (Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©) =====
@bot.message_handler(func=lambda m: m.text == "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø¯Ø´Ø©")
def search_chat(message):
    user_id = message.from_user.id
    topic = users[user_id]["topic"]
    for uid, u in users.items():
        if uid != user_id and u["topic"] == topic and u["chat_partner"] is None:
            # Ù…Ø·Ø§Ø¨Ù‚Ø©
            users[user_id]["chat_partner"] = uid
            users[uid]["chat_partner"] = user_id
            chats[(user_id, uid)] = []
            intro1 = (f"ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø¯Ø±Ø¯Ø´Ø©!\n"
                      f"ğŸ‘¤ {u['name']} ({u['age']} Ø³Ù†Ø©)\n{u['gender']}\n"
                      f"ğŸ’¯ Ø§Ø­ØªØ±Ø§Ù…Ù‡: {u['respect']}")
            intro2 = (f"ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø¯Ø±Ø¯Ø´Ø©!\n"
                      f"ğŸ‘¤ {users[user_id]['name']} ({users[user_id]['age']} Ø³Ù†Ø©)\n"
                      f"{users[user_id]['gender']}\n"
                      f"ğŸ’¯ Ø§Ø­ØªØ±Ø§Ù…Ù‡: {users[user_id]['respect']}")
            leave_btn = ReplyKeyboardMarkup(resize_keyboard=True)
            leave_btn.add("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº", "ğŸšª Ù…ØºØ§Ø¯Ø±Ø©")
            bot.send_message(user_id, intro1, reply_markup=leave_btn)
            bot.send_message(uid, intro2, reply_markup=leave_btn)
            return
    bot.send_message(user_id, "âŒ› Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.")

# ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ =====
@bot.message_handler(func=lambda m: True)
def relay_messages(message):
    user_id = message.from_user.id
    if user_id not in users or not users[user_id]["chat_partner"]:
        return

    partner_id = users[user_id]["chat_partner"]

    # ØªØ­Ù‚Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø©
    lower_msg = message.text.lower()
    if any(bad in lower_msg for bad in bad_words):
        users[user_id]["warnings"] += 1
        users[user_id]["respect"] -= 5 + users[user_id]["warnings"]
        if users[user_id]["respect"] <= 25:
            bot.send_message(user_id, "â›” ØªÙ… Ø­Ø¸Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£Ù„ÙØ§Ø¸ Ø§Ù„Ø¨Ø°ÙŠØ¦Ø©.")
            users[user_id]["chat_partner"] = None
            users[partner_id]["chat_partner"] = None
            return
        elif users[user_id]["respect"] <= 40:
            users[user_id]["banned_until"] = time.time() + 7 * 24 * 3600
            bot.send_message(user_id, "â³ ØªÙ… Ø­Ø¸Ø±Ùƒ Ø¬Ø²Ø¦ÙŠØ§Ù‹ Ù„Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹.")
            return

    # Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¢Ø®Ø± 50 ÙÙ‚Ø·)
    chats[(user_id, partner_id)] = chats.get((user_id, partner_id), [])[-49:] + [message.text]

    # Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
    bot.send_message(partner_id, f"{users[user_id]['name']} ğŸ’¬: {message.text}")

# ===== ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª =====
try:
    print("ğŸ¤– Bot is running...")
    bot.infinity_polling(skip_pending=True)
except Exception as e:
    print(f"âŒ Bot stopped due to: {e}") 
