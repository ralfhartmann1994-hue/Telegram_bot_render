import os
import time
import threading
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
import random

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("Ø¶Ø¹ TELEGRAM_TOKEN ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¹Ù„Ù‰ Render")

bot = telebot.TeleBot(TOKEN)

# ===== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© =====
users = {}            # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
active_chats = {}     # user_id -> partner_id
leave_timers = {}     # user_id -> ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
chat_history = {}     # user_id -> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®ÙŠØ±Ø© (50 Ø±Ø³Ø§Ù„Ø©)
SEARCH_TIMEOUT = 3600  # 1 Ø³Ø§Ø¹Ø© Ø¨Ø­Ø«
BAD_WORDS = [
    "ÙƒØ³","ÙƒØ³Ù…Ùƒ","ÙƒØ³ÙŠ","ÙƒØ³Ø³","ÙƒØ³Ø³Ø³","ÙƒØ³Ø³Ø³Ø³","ÙƒØ³Ù…Ùˆ","ÙƒØµÙ…Ùƒ","Ø§ÙŠØ±","Ø§ÙŠØ±ÙŠ","Ø§ÙŠØ±Ù†Ø§",
    "Ø·ÙŠØ²Ù†Ø§","Ø·ÙŠØ²","ÙƒØ³Ø®ØªÙƒ","ÙŠÙ„Ø¹Ù† Ø±Ø¨Ùƒ","ÙŠÙ„Ø¹Ù† Ø¯ÙŠÙ†Ùƒ","ÙŠÙ„Ø¹Ù† Ø±ÙˆØ­Ùƒ","Ø¹Ù†Ø±Ø¨Ùƒ","Ø¹Ù†Ø¯ÙŠÙ†Ùƒ",
    "ÙŠÙ„Ø¹Ù† Ø´ÙØ±Ø§ØªÙƒ","Ù‚Ø­Ø¨Ø©","Ø´Ø±Ù…ÙˆØ·Ø©","Ø´Ù„ÙƒØ©","Ù…Ù†ØªØ§ÙƒØ©","Ø³Ø±Ù…ÙˆØ·Ø©","Ù‚Ø­Ø¨","Ø´Ø±Ù…ÙˆØ·","Ù…Ù†ÙŠÙƒ","Ù…ÙƒØ³ÙƒØ³"
]

# ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =====
def get_respect_badge(score: int) -> str:
    if score >= 80:
        return "ğŸŒŸ"
    if score >= 60:
        return "ğŸ™‚"
    if score >= 40:
        return "âš ï¸"
    return "ğŸš«"

def main_menu(uid):
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"))
    kb.add(KeyboardButton("ğŸ“Š Ù…Ù„ÙÙŠ"))
    kb.add(KeyboardButton("ğŸ” Ø¨Ø­Ø«"))
    return kb

def send_delayed(uid, text, delay=None):
    time.sleep(delay if delay else random.uniform(0.5, 1))
    bot.send_message(uid, text)

# ===== Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
@bot.message_handler(commands=["start"])
def start(message):
    uid = message.chat.id
    if uid not in users:
        users[uid] = {
            "name": message.from_user.first_name or "",
            "gender": None,
            "age": None,
            "respect": 80,
            "gender_changes": 0,
            "step": "gender",
            "topic": None,
            "bad_words_count": 0
        }
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.add(*[KeyboardButton(g) for g in ["ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰"]])
        send_delayed(uid, "ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§! Ù…Ø§ Ù‡Ùˆ Ø¬Ù†Ø³ÙƒØŸ", 0.5)
    else:
        send_delayed(uid, "ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ...", 0.5)
        choose_topic(message)

# ===== Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
@bot.message_handler(func=lambda m: m.text in ["ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", "ğŸ“Š Ù…Ù„ÙÙŠ", "ğŸ” Ø¨Ø­Ø«"])
def main_buttons(message):
    uid = message.chat.id
    if message.text == "ğŸ“Š Ù…Ù„ÙÙŠ":
        my_profile(message)
    elif message.text == "ğŸ” Ø¨Ø­Ø«" or message.text == "ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©":
        choose_topic(message)

# ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù†Ø³ =====
@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "gender")
def set_gender(message):
    uid = message.chat.id
    txt = message.text
    if txt not in ["ğŸ‘¨ Ø°ÙƒØ±", "ğŸ‘© Ø£Ù†Ø«Ù‰"]:
        send_delayed(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.", 0.5)
        return
    users[uid]["gender"] = "Ø°ÙƒØ±" if "Ø°ÙƒØ±" in txt else "Ø£Ù†Ø«Ù‰"
    users[uid]["step"] = "age"
    send_delayed(uid, "ğŸ‚ ÙƒÙ… Ø¹Ù…Ø±ÙƒØŸ", 0.5,)

# ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ø± =====
@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "age")
def set_age(message):
    uid = message.chat.id
    if not message.text.isdigit():
        send_delayed(uid, "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø± ÙƒØ±Ù‚Ù….", 0.5)
        return
    users[uid]["age"] = int(message.text)
    users[uid]["step"] = None
    send_delayed(uid, "âœ… ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ!", 0.5)
    send_delayed(uid, "ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ...", 0.5)
    choose_topic(message)

# ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
def my_profile(message):
    uid = message.chat.id
    u = users.get(uid)
    if not u:
        send_delayed(uid, "â„¹ï¸ Ø§Ø¨Ø¯Ø£ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± /start", 0.5)
        return
    badge = get_respect_badge(u.get("respect", 80))
    bot.send_message(uid,
        f"ğŸ“Š Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ:\n"
        f"â€¢ Ø§Ù„Ø§Ø³Ù…: {u.get('name') or 'â€”'}\n"
        f"â€¢ Ø§Ù„Ø¬Ù†Ø³: {u.get('gender') or 'â€”'}\n"
        f"â€¢ Ø§Ù„Ø¹Ù…Ø±: {u.get('age') or 'â€”'}\n"
        f"â€¢ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§Ù…: {u.get('respect', 80)} {badge}\n\n"
        f"Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ.",
        reply_markup=main_menu(uid)
    )

# ===== Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© =====
def choose_topic(message):
    uid = message.chat.id
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for t in ["ğŸ“š ÙÙ„Ø³ÙØ©", "âš½ Ø±ÙŠØ§Ø¶Ø©", "â˜ªï¸ Ø¯ÙŠÙ†", "ğŸ—³ï¸ Ø³ÙŠØ§Ø³Ø©", "ğŸ¤ ØªØ¹Ø§Ø±Ù"]:
        kb.add(KeyboardButton(t))
    users[uid]["step"] = "topic"
    send_delayed(uid, "ğŸ’¬ Ø¹Ù† Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØªØ­Ø¯Ø« Ø§Ù„ÙŠÙˆÙ…ØŸ", 0.5)
    bot.send_message(uid, "Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:", reply_markup=kb)

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "topic")
def topic_selected(message):
    uid = message.chat.id
    if message.text not in ["ğŸ“š ÙÙ„Ø³ÙØ©", "âš½ Ø±ÙŠØ§Ø¶Ø©", "â˜ªï¸ Ø¯ÙŠÙ†", "ğŸ—³ï¸ Ø³ÙŠØ§Ø³Ø©", "ğŸ¤ ØªØ¹Ø§Ø±Ù"]:
        send_delayed(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·.", 0.5)
        return
    users[uid]["topic"] = message.text
    users[uid]["step"] = "search_gender"
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø¬Ù„ ğŸ‘¨"))
    kb.add(KeyboardButton("ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØªØ§Ø© ğŸ‘©"))
    bot.send_message(uid, "ğŸ‘¥ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±ÙŠÙƒ:", reply_markup=kb)

# ===== Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø·ÙˆÙŠÙ„Ø© =====
def find_partner(uid):
    start_time = time.time()
    my_topic = users[uid].get("topic")
    desired_gender = users[uid].get("desired_gender")
    while True:
        for other_id, data in users.items():
            if other_id == uid or other_id in active_chats or uid in active_chats:
                continue
            if data.get("topic") == my_topic and data.get("gender") == desired_gender:
                active_chats[uid] = other_id
                active_chats[other_id] = uid
                leave_timers[uid] = time.time()
                leave_timers[other_id] = time.time()
                chat_history[uid] = []
                chat_history[other_id] = []
                kb = ReplyKeyboardMarkup(resize_keyboard=True).add(KeyboardButton("âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª"), KeyboardButton("ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"))
                send_delayed(other_id, "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ! ğŸ‰ Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†.", 0.5)
                bot.send_message(uid, "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ! ğŸ‰ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†.", reply_markup=kb)
                return
        if time.time() - start_time > SEARCH_TIMEOUT:
            send_delayed(uid, "âŒ› Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙŠÙƒ Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø© Ù…Ù† Ø§Ù„Ø¨Ø­Ø«ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.", 0.5)
            return
        time.sleep(5)

@bot.message_handler(func=lambda m: users.get(m.chat.id, {}).get("step") == "search_gender")
def do_search(message):
    uid = message.chat.id
    choice = message.text
    if choice not in ["ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø¬Ù„ ğŸ‘¨", "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØªØ§Ø© ğŸ‘©"]:
        send_delayed(uid, "âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.", 0.5)
        return
    users[uid]["desired_gender"] = "Ø°ÙƒØ±" if "Ø±Ø¬Ù„" in choice else "Ø£Ù†Ø«Ù‰"
    users[uid]["step"] = None
    send_delayed(uid, "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ...", 0.5)
    threading.Thread(target=find_partner, args=(uid,)).start()

# ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…ØºØ§Ø¯Ø±Ø© =====
@bot.message_handler(func=lambda m: m.text in ["âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª", "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº"])
def chat_control(message):
    uid = message.chat.id
    text = message.text
    if uid not in active_chats:
        send_delayed(uid, "â„¹ï¸ Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.", 0.5)
        return
    partner = active_chats[uid]
    
    if text == "âŒ Ù…ØºØ§Ø¯Ø±Ø© ğŸšª":
        elapsed = time.time() - leave_timers.get(uid, 0)
        if elapsed < 30:
            remaining = int(30 - elapsed)
            send_delayed(uid, f"â³ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ù‚Ø¨Ù„ 30 Ø«Ø§Ù†ÙŠØ©. Ø§Ù†ØªØ¸Ø± {remaining} Ø«Ø§Ù†ÙŠØ©.", 0.5)
            return
        kb = ReplyKeyboardMarkup(resize_keyboard=True)
        kb.add(KeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©"))
        send_delayed(uid, "âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ", 0.5)
        bot.send_message(uid, "Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ£ÙƒÙŠØ¯:", reply_markup=kb)
    
    elif text == "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©":
        bot.send_message(partner, "ğŸšª ØºØ§Ø¯Ø± Ø´Ø±ÙŠÙƒÙƒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
        send_delayed(uid, "ğŸšª ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.", 0.5)
        for x in (uid, partner):
            active_chats.pop(x, None)
            leave_timers.pop(x, None)
            chat_history.pop(x, None)
    
    elif text == "ğŸš¨ Ø¥Ø¨Ù„Ø§Øº":
        history = chat_history.get(uid, [])
        bad_count = sum(1 for msg in history for word in BAD_WORDS if word in msg)
        points = bad_count // 3
        users[partner]["respect"] = max(0, users[partner].get("respect", 80) - points)
        send_delayed(uid, f"âœ… ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. {points} Ù†Ù‚Ø·Ø©/Ù†Ù‚Ø§Ø· ØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§Ù….", 0.5)

# ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø±ÙŠÙƒÙŠÙ† Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø© =====
@bot.message_handler(func=lambda m: True)
def relay(message):
    uid = message.chat.id
    if uid in active_chats:
        partner = active_chats[uid]
        text = message.text
        chat_history.setdefault(uid, []).append(text)
        if len(chat_history[uid]) > 50:
            chat_history[uid].pop(0)
        # ÙƒØ´Ù Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø°ÙŠØ¦Ø© ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…
        bad_count = sum(1 for word in BAD_WORDS if word in text)
        users[uid]["bad_words_count"] += bad_count
        points = users[uid]["bad_words_count"] // 3 - (users[uid].get("respect_deducted", 0))
        if points > 0:
            users[uid]["respect"] = max(0, users[uid]["respect"] - points)
            users[uid]["respect_deducted"] = users[uid].get("respect_deducted", 0) + points
        sender_name = users.get(uid, {}).get("name") or "Ù…Ø³ØªØ®Ø¯Ù…"
        bot.send_message(partner, f"ğŸ’¬ {sender_name}: {text}")
    else:
        send_delayed(uid, "â„¹ï¸ Ø§Ø®ØªØ± ğŸ” Ø¨Ø­Ø« Ù„Ù„Ø¨Ø¯Ø¡.", 0.5)

# ===== ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª =====
if __name__ == "__main__":
    bot.infinity_polling(skip_pending=True, timeout=20, long_polling_timeout=20)
